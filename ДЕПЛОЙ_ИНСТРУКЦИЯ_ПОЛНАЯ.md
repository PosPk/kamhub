# üöÄ –ü–û–õ–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –î–ï–ü–õ–û–Æ KAMCHATOUR HUB

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∫-—Å–µ—Ä–≤–µ—Ä—É)
2. [–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞](#–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-—Å–µ—Ä–≤–µ—Ä–∞)
3. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
4. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-postgresql)
5. [–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞](#–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø—Ä–æ–µ–∫—Ç–∞)
6. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-nginx)
7. [–ó–∞–ø—É—Å–∫ —Å PM2](#–∑–∞–ø—É—Å–∫-—Å-pm2)
8. [–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞](#–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ-–∫–æ–¥–∞)
9. [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](#—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º)
10. [–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## üñ•Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- **–û–°**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **CPU**: 2 —è–¥—Ä–∞
- **RAM**: 4 GB
- **SSD**: 20 GB
- **Node.js**: 18.x –∏–ª–∏ 20.x
- **PostgreSQL**: 14+
- **Nginx**: 1.18+

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- **CPU**: 4 —è–¥—Ä–∞
- **RAM**: 8 GB
- **SSD**: 50 GB

---

## üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

```bash
# Ubuntu/Debian
sudo apt install -y curl wget git build-essential

# CentOS/RHEL
sudo yum install -y curl wget git gcc-c++ make
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞

```bash
# UFW (Ubuntu/Debian)
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# FirewallD (CentOS/RHEL)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20.x

```bash
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è NodeSource
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
sudo apt install -y nodejs

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
node --version  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å v20.x.x
npm --version   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 10.x.x
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL 14+

```bash
# Ubuntu/Debian
sudo apt install -y postgresql postgresql-contrib

# –ó–∞–ø—É—Å–∫ PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status postgresql
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx

```bash
# Ubuntu/Debian
sudo apt install -y nginx

# –ó–∞–ø—É—Å–∫ Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status nginx
```

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 (–≥–ª–æ–±–∞–ª—å–Ω–æ)

```bash
sudo npm install -g pm2

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ PM2
pm2 startup
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–µ–¥–ª–æ–∂–∏—Ç PM2

# –ü—Ä–æ–≤–µ—Ä–∫–∞
pm2 --version
```

---

## üóÑÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
# –í–æ–π—Ç–∏ –≤ PostgreSQL
sudo -u postgres psql

# –í –∫–æ–Ω—Å–æ–ª–∏ PostgreSQL –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
CREATE DATABASE kamhub;
CREATE USER kamhub_user WITH ENCRYPTED PASSWORD '–≤–∞—à_—Å—É–ø–µ—Ä_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–ø–∞—Ä–æ–ª—å';
GRANT ALL PRIVILEGES ON DATABASE kamhub TO kamhub_user;

# –î–ª—è PostgreSQL 15+
\c kamhub
GRANT ALL ON SCHEMA public TO kamhub_user;

# –í—ã—Ö–æ–¥
\q
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å pg_hba.conf
sudo nano /etc/postgresql/14/main/pg_hba.conf

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞):
local   all             kamhub_user                             md5

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PostgreSQL
sudo systemctl restart postgresql
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```bash
psql -U kamhub_user -d kamhub -h localhost
# –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
```

---

## üìÅ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
sudo mkdir -p /var/www/kamhub
sudo chown -R $USER:$USER /var/www/kamhub
cd /var/www/kamhub
```

### 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Git
git clone https://github.com/–≤–∞—à-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/kamhub.git .

# –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ SCP —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:
scp -r /–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/* user@—Å–µ—Ä–≤–µ—Ä:/var/www/kamhub/
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .env

```bash
cd /var/www/kamhub
nano .env
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ `.env`:**

```env
# Database
DATABASE_URL="postgresql://kamhub_user:–≤–∞—à_–ø–∞—Ä–æ–ª—å@localhost:5432/kamhub?schema=public"

# NextAuth
NEXTAUTH_SECRET="—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ_—Å–ª—É—á–∞–π–Ω—É—é_—Å—Ç—Ä–æ–∫—É_32_—Å–∏–º–≤–æ–ª–∞"
NEXTAUTH_URL="https://kamchatour.ru"

# Telegram Bot
TELEGRAM_BOT_TOKEN="–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞_–æ—Ç_BotFather"

# API Keys (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
OPENAI_API_KEY="–≤–∞—à_–∫–ª—é—á_openai"

# Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="–≤–∞—à_email@gmail.com"
SMTP_PASSWORD="–ø–∞—Ä–æ–ª—å_–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"

# Yandex Maps (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
YANDEX_MAPS_API_KEY="–≤–∞—à_–∫–ª—é—á_yandex"

# Environment
NODE_ENV="production"
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è NEXTAUTH_SECRET:**

```bash
openssl rand -base64 32
```

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd /var/www/kamhub
npm install
```

### 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Prisma
npx prisma generate
npx prisma migrate deploy

# –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)
npx prisma db push
```

### 6. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –ï—Å–ª–∏ –µ—Å—Ç—å seed-—Å–∫—Ä–∏–ø—Ç
npm run seed

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL
psql -U kamhub_user -d kamhub -h localhost -f /var/www/kamhub/scripts/seed.sql
```

### 7. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
cd /var/www/kamhub
npm run build
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏:**

```bash
# –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –ø–∞–ø–∫–∞ .next
ls -la .next/
```

---

## üåê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

```bash
sudo nano /etc/nginx/sites-available/kamhub
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ñ–∏–≥–∞:**

```nginx
# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å www –Ω–∞ –±–µ–∑ www
server {
    listen 80;
    listen [::]:80;
    server_name www.kamchatour.ru;
    return 301 http://kamchatour.ru$request_uri;
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
server {
    listen 80;
    listen [::]:80;
    server_name kamchatour.ru;

    # –õ–æ–≥–∏
    access_log /var/log/nginx/kamhub_access.log;
    error_log /var/log/nginx/kamhub_error.log;

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    client_max_body_size 50M;

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Next.js
    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    location /_next/static/ {
        proxy_pass http://localhost:8080;
        proxy_cache_valid 200 365d;
        proxy_cache_bypass $http_cache_control;
        add_header Cache-Control "public, immutable";
    }

    # –ü—É–±–ª–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã
    location /public/ {
        proxy_pass http://localhost:8080;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, max-age=604800";
    }
}
```

### 2. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
sudo ln -s /etc/nginx/sites-available/kamhub /etc/nginx/sites-enabled/

# –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo rm /etc/nginx/sites-enabled/default

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo nginx -t

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx
sudo systemctl restart nginx
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL (Let's Encrypt)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Certbot
sudo apt install -y certbot python3-certbot-nginx

# –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
sudo certbot --nginx -d kamchatour.ru -d www.kamchatour.ru

# –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
sudo certbot renew --dry-run
```

**–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SSL –∫–æ–Ω—Ñ–∏–≥ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.**

---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ —Å PM2

### 1. –°–æ–∑–¥–∞–Ω–∏–µ ecosystem.config.js (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)

```bash
cd /var/www/kamhub
nano ecosystem.config.js
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

```javascript
module.exports = {
  apps: [
    {
      name: 'kamhub',
      script: 'npm',
      args: 'start',
      cwd: '/var/www/kamhub',
      instances: 1,
      exec_mode: 'fork',
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production',
        PORT: 8080
      },
      error_file: '/var/log/pm2/kamhub-error.log',
      out_file: '/var/log/pm2/kamhub-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z'
    }
  ]
};
```

### 2. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ PM2
sudo mkdir -p /var/log/pm2
sudo chown -R $USER:$USER /var/log/pm2

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
cd /var/www/kamhub
pm2 start ecosystem.config.js

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é:
pm2 start npm --name kamhub -- start

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 save

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
pm2 startup
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 status

# –õ–æ–≥–∏
pm2 logs kamhub

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
pm2 monit
```

### 4. –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã PM2

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
pm2 restart kamhub

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
pm2 stop kamhub

# –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
pm2 delete kamhub

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
pm2 flush

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
pm2 info kamhub
```

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Git

```bash
cd /var/www/kamhub

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin main

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å)
npm install

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å)
npx prisma migrate deploy

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PM2
pm2 restart kamhub
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ SCP (—Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã)

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
cd /–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É

# –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ª–æ–∫–∞–ª—å–Ω–æ
npm run build

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp -r .next package.json package-lock.json user@—Å–µ—Ä–≤–µ—Ä:/var/www/kamhub/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh user@—Å–µ—Ä–≤–µ—Ä
cd /var/www/kamhub
npm install
pm2 restart kamhub
```

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `deploy.sh` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**

```bash
nano /var/www/kamhub/deploy.sh
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

```bash
#!/bin/bash

set -e

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è..."

cd /var/www/kamhub

echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
git pull origin main

echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
npx prisma migrate deploy

echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

echo "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
pm2 restart kamhub

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"

echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 status kamhub
```

**–°–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º:**

```bash
chmod +x /var/www/kamhub/deploy.sh
```

**–ó–∞–ø—É—Å–∫:**

```bash
/var/www/kamhub/deploy.sh
```

---

## üîç –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –°–∞–π—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è (502 Bad Gateway)

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å PM2
pm2 status

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω
pm2 restart kamhub

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs kamhub --lines 50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Nginx
sudo nginx -t
sudo systemctl status nginx
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å PostgreSQL
sudo systemctl status postgresql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
psql -U kamhub_user -d kamhub -h localhost

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DATABASE_URL –≤ .env
cat /var/www/kamhub/.env | grep DATABASE_URL

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL
sudo systemctl restart postgresql
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—à–∏–±–∫–∏ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ (npm run build)

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
rm -rf .next node_modules package-lock.json
npm install
npm run build

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é Node.js
node --version  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å v18+ –∏–ª–∏ v20+

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–º—è—Ç—å
free -h  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2GB —Å–≤–æ–±–æ–¥–Ω–æ

# –£–≤–µ–ª–∏—á–∏—Ç—å –ø–∞–º—è—Ç—å –¥–ª—è Node.js
NODE_OPTIONS="--max-old-space-size=4096" npm run build
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
htop

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PM2
pm2 monit

# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ (–≤ ecosystem.config.js)
# instances: 'max' –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —á–∏—Å–ª–æ

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pm2 reload ecosystem.config.js
```

### –ü—Ä–æ–±–ª–µ–º–∞ 5: SSL –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
sudo certbot certificates

# –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
sudo certbot renew --force-renewal

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ Nginx
sudo nginx -t
sudo systemctl reload nginx
```

---

## üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø:**

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p /var/backups/kamhub

# –°–æ–∑–¥–∞—Ç—å –¥–∞–º–ø –ë–î
pg_dump -U kamhub_user -h localhost kamhub > /var/backups/kamhub/kamhub_$(date +%Y%m%d_%H%M%S).sql

# –° —Å–∂–∞—Ç–∏–µ–º
pg_dump -U kamhub_user -h localhost kamhub | gzip > /var/backups/kamhub/kamhub_$(date +%Y%m%d_%H%M%S).sql.gz
```

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±—ç–∫–∞–ø:**

```bash
# –ë–µ–∑ —Å–∂–∞—Ç–∏—è
psql -U kamhub_user -h localhost kamhub < /var/backups/kamhub/kamhub_20250102_120000.sql

# –°–æ —Å–∂–∞—Ç–∏–µ–º
gunzip -c /var/backups/kamhub/kamhub_20250102_120000.sql.gz | psql -U kamhub_user -h localhost kamhub
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±—ç–∫–∞–ø–æ–≤ (cron)

```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞
sudo nano /usr/local/bin/backup-kamhub.sh
```

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

```bash
#!/bin/bash

BACKUP_DIR="/var/backups/kamhub"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="kamhub"
DB_USER="kamhub_user"

mkdir -p $BACKUP_DIR

# –ë—ç–∫–∞–ø –ë–î
pg_dump -U $DB_USER -h localhost $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# –ë—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–±–µ–∑ node_modules –∏ .next)
tar -czf $BACKUP_DIR/files_$DATE.tar.gz \
    --exclude='node_modules' \
    --exclude='.next' \
    --exclude='.git' \
    /var/www/kamhub

# –£–¥–∞–ª–∏—Ç—å –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "–ë—ç–∫–∞–ø –∑–∞–≤–µ—Ä—à—ë–Ω: $DATE"
```

**–°–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º:**

```bash
sudo chmod +x /usr/local/bin/backup-kamhub.sh
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ cron (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00):**

```bash
sudo crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É:
0 3 * * * /usr/local/bin/backup-kamhub.sh >> /var/log/backup-kamhub.log 2>&1
```

### 3. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSH-–∫–ª—é—á –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
ssh-keygen -t rsa -b 4096
ssh-copy-id user@backup-server

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ç–∫–∞–ø–æ–≤
#!/bin/bash
BACKUP_FILE="/var/backups/kamhub/db_$(date +%Y%m%d_%H%M%S).sql.gz"
pg_dump -U kamhub_user -h localhost kamhub | gzip > $BACKUP_FILE
scp $BACKUP_FILE user@backup-server:/path/to/backups/
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### PM2 –ª–æ–≥–∏

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 logs kamhub

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
pm2 logs kamhub --lines 100

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
pm2 logs kamhub --err

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
pm2 flush kamhub
```

### Nginx –ª–æ–≥–∏

```bash
# Access log
sudo tail -f /var/log/nginx/kamhub_access.log

# Error log
sudo tail -f /var/log/nginx/kamhub_error.log

# –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫
sudo grep "error" /var/log/nginx/kamhub_error.log | tail -20
```

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –∏ –ø–∞–º—è—Ç–∏
htop

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
df -h

# –°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
netstat -tulnp | grep :8080
netstat -tulnp | grep :80
```

### PM2 Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 Plus (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω)
pm2 link <PUBLIC_KEY> <SECRET_KEY>

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pm2-web
npm install -g pm2-web
pm2-web --config pm2-web.json
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH

```bash
# –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é (—Ç–æ–ª—å–∫–æ SSH-–∫–ª—é—á–∏)
sudo nano /etc/ssh/sshd_config

# –ò–∑–º–µ–Ω–∏—Ç—å:
PasswordAuthentication no
PermitRootLogin no

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å SSH
sudo systemctl restart sshd
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Fail2Ban

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo apt install -y fail2ban

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
sudo nano /etc/fail2ban/jail.local

# –î–æ–±–∞–≤–∏—Ç—å:
[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

# –ó–∞–ø—É—Å–∫
sudo systemctl start fail2ban
sudo systemctl enable fail2ban
```

### 3. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure --priority=low unattended-upgrades
```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–ü—Ä–æ–µ–∫—Ç**: Kamchatour Hub  
**–°–µ—Ä–≤–µ—Ä**: 5.129.248.224  
**–î–æ–º–µ–Ω**: https://kamchatour.ru  
**–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: 8080

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- Next.js –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://nextjs.org/docs
- PM2 –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://pm2.keymetrics.io/docs/usage/quick-start/
- Nginx –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://nginx.org/ru/docs/
- PostgreSQL –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://www.postgresql.org/docs/

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –°–µ—Ä–≤–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω (–æ–±–Ω–æ–≤–ª—ë–Ω, –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ñ–∞–π—Ä–≤–æ–ª)
- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Node.js 20.x, PostgreSQL 14+, Nginx
- [ ] –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω —Ñ–∞–π–ª `.env` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- [ ] –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫ (`npm run build`)
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`npx prisma migrate deploy`)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω Nginx —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [ ] –ü–æ–ª—É—á–µ–Ω SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (Let's Encrypt)
- [ ] PM2 –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- [ ] –°–∞–π—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –¥–æ–º–µ–Ω—É

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-02  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–°—Ç–∞—Ç—É—Å**: Production Ready ‚úÖ
