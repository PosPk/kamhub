name: ๐ Deploy via Timeweb API (TIMEWEB_TOKEN1)

on:
  push:
    branches:
      - main
      - master
      - cursor/**
  workflow_dispatch:
    inputs:
      action:
        description: 'ะะตะนััะฒะธะต'
        required: false
        default: 'deploy'
        type: choice
        options:
          - setup
          - deploy
          - status

env:
  NODE_VERSION: '20'

jobs:
  setup-infrastructure:
    name: ๐๏ธ ะะฐัััะพะนะบะฐ ะธะฝััะฐััััะบัััั Timeweb
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'setup' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4

      - name: ๐ง Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ๐ฆ Install dependencies
        run: npm install -g tsx

      - name: ๐๏ธ ะะฐัััะพะนะบะฐ ะธะฝััะฐััััะบัััั Timeweb ัะตัะตะท API
        env:
          TIMEWEB_TOKEN: ${{ secrets.TIMEWEB_TOKEN1 }}
        run: |
          if [ -z "$TIMEWEB_TOKEN" ]; then
            echo "โ TIMEWEB_TOKEN1 ะฝะต ะฝะฐะนะดะตะฝ ะฒ GitHub Secrets!"
            echo "ะะพะฑะฐะฒััะต ัะตะบัะตั: TIMEWEB_TOKEN1"
            exit 1
          fi
          
          echo "๐ ะะฐัะฐะปะพ ะฝะฐัััะพะนะบะธ ะธะฝััะฐััััะบัััั ัะตัะตะท Timeweb API..."
          echo "ะัะฟะพะปัะทัะตััั ัะพะบะตะฝ ะธะท TIMEWEB_TOKEN1"
          tsx scripts/timeweb-setup.ts

      - name: ๐พ ะกะพััะฐะฝะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพะฑ ะธะฝััะฐััััะบัััะต
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: timeweb-infrastructure
          path: |
            timeweb-resources.json
            .env.production.timeweb
          retention-days: 90

      - name: ๐ ะกะปะตะดัััะธะต ัะฐะณะธ
        if: always()
        run: |
          echo "โ ะะฐัััะพะนะบะฐ ะธะฝััะฐััััะบัััั ะทะฐะฒะตััะตะฝะฐ!"
          echo ""
          echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
          echo "1. ะกะบะฐัะฐะนัะต ะฐััะตัะฐะบัั ะธะท ััะพะณะพ ะทะฐะฟััะบะฐ"
          echo "2. ะะพะฑะฐะฒััะต ะฝะตะพะฑัะพะดะธะผัะต ัะตะบัะตัั ะฒ GitHub:"
          echo "   - DATABASE_URL (ะธะท .env.production.timeweb)"
          echo "   - SERVER_HOST (ะธะท timeweb-resources.json)"
          echo "3. ะะฐะฟัััะธัะต ะดะตะฟะปะพะน ัะตัะตะท push ะธะปะธ workflow_dispatch"

  check-status:
    name: ๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'status'
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4

      - name: ๐ง Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ๐ฆ Install dependencies
        run: npm install -g tsx

      - name: ๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟัะพะตะบัะฐ
        env:
          TIMEWEB_TOKEN: ${{ secrets.TIMEWEB_TOKEN1 }}
        run: |
          if [ -z "$TIMEWEB_TOKEN" ]; then
            echo "โ TIMEWEB_TOKEN1 ะฝะต ะฝะฐะนะดะตะฝ!"
            exit 1
          fi
          echo "๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตัะตะท Timeweb API..."
          tsx scripts/timeweb-manage.ts project

      - name: ๐ ะกะฟะธัะพะบ ัะตััััะพะฒ
        env:
          TIMEWEB_TOKEN: ${{ secrets.TIMEWEB_TOKEN1 }}
        run: |
          echo "๐ฆ ะกะฟะธัะพะบ ะฒัะตั ัะตััััะพะฒ..."
          tsx scripts/timeweb-manage.ts list

  deploy:
    name: ๐ ะะตะฟะปะพะน ะฟัะธะปะพะถะตะฝะธั
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'deploy' || github.event.inputs.action == '' || github.event_name == 'push'
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4

      - name: ๐ง Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ๐ฆ Install dependencies
        run: npm ci

      - name: ๐งช Run tests
        run: npm test || echo "โ๏ธ ะขะตััั ะฝะต ะฝะฐะนะดะตะฝั, ะฟัะพะฟััะบะฐะตะผ..."

      - name: ๐๏ธ Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://kamchatour.timeweb.app' }}
          NODE_ENV: production

      - name: ๐ ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ัะตัะฒะตัะต ัะตัะตะท API
        env:
          TIMEWEB_TOKEN: ${{ secrets.TIMEWEB_TOKEN1 }}
        run: |
          if [ -z "$TIMEWEB_TOKEN" ]; then
            echo "โ TIMEWEB_TOKEN1 ะฝะต ะฝะฐะนะดะตะฝ ะฒ GitHub Secrets!"
            echo "ะะพะฑะฐะฒััะต ัะตะบัะตั: TIMEWEB_TOKEN1"
            exit 1
          fi
          
          echo "๐ ะะพะปััะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพ ัะตัะฒะตัะต ัะตัะตะท Timeweb API..."
          
          # ะะพะฟััะบะฐ ะฟะพะปััะธัั ะธะฝัะพัะผะฐัะธั ะพ ัะตัะฒะตัะต ัะตัะตะท API
          SERVER_INFO=$(curl -s -H "Authorization: Bearer $TIMEWEB_TOKEN" \
            https://api.timeweb.cloud/api/v1/servers | jq -r '.servers[0] // empty')
          
          if [ -z "$SERVER_INFO" ]; then
            echo "โ๏ธ ะกะตัะฒะตั ะฝะต ะฝะฐะนะดะตะฝ ัะตัะตะท API, ะธัะฟะพะปัะทัะตะผ SSH ะดะตะฟะปะพะน"
            echo "TIMEWEB_SERVER_FOUND=false" >> $GITHUB_ENV
          else
            SERVER_IP=$(echo "$SERVER_INFO" | jq -r '.ip // .external_ip // empty')
            SERVER_ID=$(echo "$SERVER_INFO" | jq -r '.id // empty')
            
            if [ -n "$SERVER_IP" ]; then
              echo "โ ะกะตัะฒะตั ะฝะฐะนะดะตะฝ: $SERVER_IP (ID: $SERVER_ID)"
              echo "TIMEWEB_SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
              echo "TIMEWEB_SERVER_ID=$SERVER_ID" >> $GITHUB_ENV
              echo "TIMEWEB_SERVER_FOUND=true" >> $GITHUB_ENV
            else
              echo "โ๏ธ IP ัะตัะฒะตัะฐ ะฝะต ะฝะฐะนะดะตะฝ, ะธัะฟะพะปัะทัะตะผ SSH ะดะตะฟะปะพะน"
              echo "TIMEWEB_SERVER_FOUND=false" >> $GITHUB_ENV
            fi
          fi

      - name: ๐ Setup SSH (ะตัะปะธ ะตััั SSH ะดะฐะฝะฝัะต)
        if: env.TIMEWEB_SERVER_FOUND == 'true' && secrets.TIMEWEB_SSH_PASSWORD != ''
        run: |
          echo "๐ ะะฐัััะพะนะบะฐ SSH ะดะปั ะดะตะฟะปะพั..."
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: ๐ ะะตะฟะปะพะน ัะตัะตะท SSH
        if: env.TIMEWEB_SERVER_FOUND == 'true'
        env:
          SSH_HOST: ${{ env.TIMEWEB_SERVER_IP }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
          PROJECT_DIR: /var/www/kamhub
        run: |
          echo "๐ ะะตะฟะปะพะน ะฝะฐ ัะตัะฒะตั $SSH_HOST..."
          
          # ะกะพะทะดะฐะตะผ ัะบัะธะฟั ะดะตะฟะปะพั
          cat > /tmp/deploy-remote.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          PROJECT_DIR="${1:-/var/www/kamhub}"
          
          echo "๐ฆ ะะฑะฝะพะฒะปะตะฝะธะต ะฟัะธะปะพะถะตะฝะธั ะฒ $PROJECT_DIR"
          
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          
          # ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ
          if [ -d .git ]; then
            echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท Git..."
            git fetch origin
            CURRENT_BRANCH=$(git branch --show-current || echo "main")
            git reset --hard origin/$CURRENT_BRANCH || git reset --hard origin/main
            git clean -fd
          else
            echo "โ๏ธ Git ะฝะต ะฝะฐะนะดะตะฝ, ะฒะพะทะผะพะถะฝะพ ะฟะตัะฒัะน ะดะตะฟะปะพะน"
          fi
          
          # ะัะพะฒะตัะบะฐ package.json
          if [ ! -f package.json ]; then
            echo "โ package.json ะฝะต ะฝะฐะนะดะตะฝ!"
            exit 1
          fi
          
          # ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
          echo "๐ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
          # ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ
          echo "๐ ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ..."
          npm run type-check || echo "โ๏ธ Type check failed, continuing..."
          
          # ะกะฑะพัะบะฐ
          echo "๐๏ธ ะกะฑะพัะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
          npm run build
          
          # ะะธะณัะฐัะธะธ
          echo "๐๏ธ ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน..."
          npm run migrate:up || echo "โ๏ธ Migrations failed, continuing..."
          
          # ะะตัะตะทะฐะฟััะบ ัะตัะตะท PM2
          echo "๐ ะะตัะตะทะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั..."
          if command -v pm2 &> /dev/null; then
            if pm2 list | grep -q "kamchatour-hub"; then
              pm2 restart kamchatour-hub --update-env
              echo "โ ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟััะตะฝะพ ัะตัะตะท PM2"
            else
              if [ -f ecosystem.config.js ]; then
                pm2 start ecosystem.config.js
              else
                pm2 start npm --name kamchatour-hub -- start
              fi
              pm2 save
              echo "โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ัะตัะตะท PM2"
            fi
            pm2 list
          else
            echo "โ๏ธ PM2 ะฝะต ัััะฐะฝะพะฒะปะตะฝ, ะทะฐะฟััะบะฐะตะผ ะฝะฐะฟััะผัั..."
            pkill -f "node.*kamhub" || true
            nohup npm start > /var/log/kamhub.log 2>&1 &
            echo "โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ (PID: $!)"
          fi
          
          echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
          DEPLOY_SCRIPT
          
          # ะะตัะตะดะฐัะฐ ะธ ะฒัะฟะพะปะฝะตะฝะธะต ัะบัะธะฟัะฐ
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" /tmp/deploy-remote.sh "$SSH_USER@$SSH_HOST:/tmp/deploy-remote.sh"
          
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << ENDSSH
            chmod +x /tmp/deploy-remote.sh
            bash /tmp/deploy-remote.sh "$PROJECT_DIR"
            rm /tmp/deploy-remote.sh
          ENDSSH

      - name: โ Health Check
        if: env.TIMEWEB_SERVER_FOUND == 'true'
        env:
          SERVER_IP: ${{ env.TIMEWEB_SERVER_IP }}
        run: |
          echo "๐ฅ ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ะฟัะธะปะพะถะตะฝะธั..."
          sleep 5
          
          if [ -n "$SERVER_IP" ]; then
            if curl -f -s "http://$SERVER_IP:3000/api/health" > /dev/null 2>&1; then
              echo "โ Health check passed!"
            else
              echo "โ๏ธ Health check failed (ะฒะพะทะผะพะถะฝะพ ัะตัะฒะตั ะตัะต ะทะฐะฟััะบะฐะตััั)"
              echo "ะัะพะฒะตัััะต ะฒัััะฝัั: http://$SERVER_IP:3000/api/health"
            fi
          fi

      - name: ๐ Deployment Summary
        if: always()
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ ะะะะะะ ะะะะะะจะะ!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ ะะตะฟะพะทะธัะพัะธะน: ${{ github.repository }}"
          echo "๐ฟ ะะตัะบะฐ: ${{ github.ref_name }}"
          echo "๐ฌ ะะพะผะผะธั: ${{ github.sha }}"
          echo "๐ค ะะฒัะพั: ${{ github.actor }}"
          if [ -n "${{ env.TIMEWEB_SERVER_IP }}" ]; then
            echo "๐ ะกะตัะฒะตั: ${{ env.TIMEWEB_SERVER_IP }}"
            echo "๐ URL: http://${{ env.TIMEWEB_SERVER_IP }}:3000"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
