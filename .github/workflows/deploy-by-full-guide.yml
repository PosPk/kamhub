name: ๐ Deploy by DEPLOY_GUIDE_FULL.md

on:
  push:
    branches:
      - main
      - master
      - cursor/**
  workflow_dispatch:

jobs:
  deploy:
    name: ๐ ะะตะฟะปะพะน ะฟะพ ะฟะพะปะฝะพะน ะธะฝััััะบัะธะธ
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4

      - name: ๐ฆ Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass curl jq

      - name: ๐ ะะฐะณััะทะบะฐ ะธะฝััััะบัะธะธ ั GitHub
        run: |
          echo "๐ ะะฐะณััะถะฐั ะธะฝััััะบัะธั DEPLOY_GUIDE_FULL.md ะธะท ะฒะตัะบะธ deploy-guide-2025..."
          curl -sL "https://raw.githubusercontent.com/PosPk/kamhub/deploy-guide-2025/ะะะะะะ_ะะะกะขะะฃะะฆะะฏ_ะะะะะะฏ.md" > /tmp/DEPLOY_GUIDE.md
          curl -sL "https://raw.githubusercontent.com/PosPk/kamhub/deploy-guide-2025/ะะซะกะขะะซะ_ะกะขะะะข_ะะะะะะ.md" > /tmp/QUICK_START.md
          
          echo "โ ะะฝััััะบัะธะธ ะทะฐะณััะถะตะฝั"
          echo "๐ DEPLOY_GUIDE: $(wc -l < /tmp/DEPLOY_GUIDE.md) ัััะพะบ"
          echo "๐ QUICK_START: $(wc -l < /tmp/QUICK_START.md) ัััะพะบ"

      - name: ๐ ะัะฟะพะปะฝะตะฝะธะต ะดะตะฟะปะพั ะฟะพ ะธะฝััััะบัะธะธ
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
          PROJECT_DIR: /var/www/kamhub
        run: |
          echo "๐ ะัะฟะพะปะฝะตะฝะธะต ะดะตะฟะปะพั ะฟะพ DEPLOY_GUIDE_FULL.md..."
          
          # ะัะฟะพะปะฝัะตะผ ะดะตะฟะปะพะน ัะพะณะปะฐัะฝะพ ะธะฝััััะบัะธะธ
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'ENDSSH'
            set -e
            
            APP_DIR="/var/www/kamhub"
            echo "๐ ะกะปะตะดัั ะธะฝััััะบัะธะธ ะธะท DEPLOY_GUIDE_FULL.md"
            
            # ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ะดะธัะตะบัะพัะธะธ
            if [ ! -d "$APP_DIR" ]; then
              echo "๐ฅ ะะตัะฒัะน ะดะตะฟะปะพะน: ัะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะธ ะบะปะพะฝะธัะพะฒะฐะฝะธะต..."
              mkdir -p /var/www
              cd /var/www
              git clone https://github.com/PosPk/kamhub.git kamhub
              cd kamhub
            else
              echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ัััะตััะฒัััะตะณะพ ะฟัะพะตะบัะฐ..."
              cd "$APP_DIR"
              
              if [ -d .git ]; then
                git fetch origin
                CURRENT_BRANCH=$(git branch --show-current || echo "main")
                git reset --hard origin/$CURRENT_BRANCH || git reset --hard origin/main || true
                git clean -fd
              else
                echo "โ๏ธ .git ะฝะต ะฝะฐะนะดะตะฝ, ะฟะตัะตัะพะทะดะฐะตะผ..."
                cd /var/www
                rm -rf kamhub
                git clone https://github.com/PosPk/kamhub.git kamhub
                cd kamhub
              fi
            fi
            
            echo "๐ฆ ะะธัะตะบัะพัะธั: $(pwd)"
            
            # ะัะพะฒะตัะบะฐ package.json
            if [ ! -f package.json ]; then
              echo "โ package.json ะฝะต ะฝะฐะนะดะตะฝ!"
              ls -la
              exit 1
            fi
            
            # ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน (ัะพะณะปะฐัะฝะพ ะธะฝััััะบัะธะธ)
            echo "๐ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            
            # ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ (ะฝะต ะฑะปะพะบะธััะตั)
            echo "๐ ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ..."
            npm run type-check || echo "โ๏ธ Type check failed, continuing..."
            
            # ะกะฑะพัะบะฐ (ัะพะณะปะฐัะฝะพ ะธะฝััััะบัะธะธ)
            echo "๐๏ธ ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ..."
            npm run build
            
            # ะะธะณัะฐัะธะธ (ัะพะณะปะฐัะฝะพ ะธะฝััััะบัะธะธ)
            echo "๐๏ธ ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน ะะ..."
            npm run migrate:up || echo "โ๏ธ Migrations failed, continuing..."
            
            # ะะฐะฟััะบ ัะตัะตะท PM2 ะฝะฐ ะฟะพััั 8080 (ัะพะณะปะฐัะฝะพ ะธะฝััััะบัะธะธ)
            echo "๐ ะะฐะฟััะบ ัะตัะตะท PM2 ะฝะฐ ะฟะพััั 8080..."
            if command -v pm2 &> /dev/null; then
              # ะะฑะฝะพะฒะปัะตะผ ecosystem.config.js ะตัะปะธ ะฝัะถะฝะพ
              if [ -f ecosystem.config.js ]; then
                # ะฃะฑะตะถะดะฐะตะผัั ััะพ ะฟะพัั 8080
                sed -i 's/PORT: 3000/PORT: 8080/g' ecosystem.config.js || true
              fi
              
              if pm2 list | grep -q "kamchatour-hub"; then
                echo "๐ ะะตัะตะทะฐะฟััะบ ัััะตััะฒัััะตะณะพ ะฟัะพัะตััะฐ..."
                pm2 restart kamchatour-hub --update-env
              else
                echo "โถ๏ธ ะะฐะฟััะบ ะฝะพะฒะพะณะพ ะฟัะพัะตััะฐ ะฝะฐ ะฟะพััั 8080..."
                if [ -f ecosystem.config.js ]; then
                  # ะฃะฑะตะถะดะฐะตะผัั ััะพ ะฟะพัั 8080 ะฒ ecosystem.config.js
                  if ! grep -q "PORT: 8080" ecosystem.config.js; then
                    sed -i 's/PORT: 3000/PORT: 8080/g' ecosystem.config.js || true
                  fi
                  pm2 start ecosystem.config.js
                else
                  echo "PORT=8080" > .env.production
                  PORT=8080 pm2 start npm --name kamchatour-hub -- start
                fi
                pm2 save
              fi
              
              pm2 list
            else
              echo "โ๏ธ PM2 ะฝะต ัััะฐะฝะพะฒะปะตะฝ, ะทะฐะฟััะบะฐะตะผ ะฝะฐะฟััะผัั ะฝะฐ 8080..."
              pkill -f "node.*kamhub" || true
              PORT=8080 nohup npm start > /var/log/kamhub.log 2>&1 &
              echo "โ ะะฐะฟััะตะฝะพ ะฝะฐ ะฟะพััั 8080 (PID: $!)"
            fi
            
            echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ะฟะพ ะธะฝััััะบัะธะธ!"
            echo "๐ ะัะธะปะพะถะตะฝะธะต ัะฐะฑะพัะฐะตั ะฝะฐ ะฟะพััั 8080"
            echo "๐ Nginx ะดะพะปะถะตะฝ ะฟัะพะบัะธัะพะฒะฐัั ะฝะฐ http://localhost:8080"
          ENDSSH

      - name: โ Health Check (ะฟะพัั 8080)
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
        run: |
          echo "๐ฅ ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ะฝะฐ ะฟะพััั 8080..."
          sleep 5
          
          # ะัะพะฒะตัะบะฐ ะฝะฐะฟััะผัั
          if curl -f -s "http://$SSH_HOST:8080/api/health" > /dev/null 2>&1; then
            echo "โ Health check passed (ะฟััะผะพะต ะฟะพะดะบะปััะตะฝะธะต ะฝะฐ 8080)"
          else
            echo "โ๏ธ Health check failed ะฝะฐ 8080"
          fi
          
          # ะัะพะฒะตัะบะฐ ัะตัะตะท Nginx (ะฟะพัั 80)
          if curl -f -s "http://$SSH_HOST/api/health" > /dev/null 2>&1; then
            echo "โ Health check passed (ัะตัะตะท Nginx ะฝะฐ 80)"
          else
            echo "โ๏ธ Health check failed ัะตัะตะท Nginx"
          fi

      - name: ๐ Deployment Summary
        if: always()
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ ะะะะะะ ะะะะะะจะะ ะะ ะะะกะขะะฃะะฆะะ!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ ะะตะฟะพะทะธัะพัะธะน: ${{ github.repository }}"
          echo "๐ฟ ะะตัะบะฐ: ${{ github.ref_name }}"
          echo "๐ฌ ะะพะผะผะธั: ${{ github.sha }}"
          echo "๐ ะกะตัะฒะตั: $SSH_HOST"
          echo "๐ ะััะผะพะน ะดะพัััะฟ: http://$SSH_HOST:8080"
          echo "๐ ะงะตัะตะท Nginx: http://$SSH_HOST"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
