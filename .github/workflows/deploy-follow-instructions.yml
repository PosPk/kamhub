name: üöÄ Deploy following DEPLOY_GUIDE_FULL.md

on:
  push:
    branches:
      - main
      - master
      - cursor/**
  workflow_dispatch:

jobs:
  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ DEPLOY_GUIDE_FULL.md
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: üìñ –ß—Ç–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
        run: |
          echo "üìñ –ß—Ç–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ DEPLOY_GUIDE_FULL.md —Å —Å–µ—Ä–≤–µ—Ä–∞..."
          
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "cat /var/www/kamhub/DEPLOY_GUIDE_FULL.md" > /tmp/DEPLOY_GUIDE_FULL.md || \
            echo "‚ö†Ô∏è –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É"
          
          if [ -f /tmp/DEPLOY_GUIDE_FULL.md ]; then
            echo "‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞:"
            cat /tmp/DEPLOY_GUIDE_FULL.md | head -50
          fi

      - name: üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
        run: |
          echo "üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ DEPLOY_GUIDE_FULL.md..."
          
          # –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë, –∏–Ω–∞—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
          if [ -f /tmp/DEPLOY_GUIDE_FULL.md ]; then
            echo "üìñ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞"
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
          else
            echo "üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–µ–ø–ª–æ—è"
          fi
          
          # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'ENDSSH'
            cd /var/www/kamhub || /var/www/kamchatour-hub || exit 1
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —á–∏—Ç–∞–µ–º –µ—ë
            if [ -f DEPLOY_GUIDE_FULL.md ]; then
              echo "üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
            fi
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
            if [ -d .git ]; then
              git fetch origin
              git pull origin main || git pull origin master
            else
              echo "üì• –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π: –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..."
              cd /var/www
              git clone https://github.com/PosPk/kamhub.git kamhub
              cd kamhub
            fi
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            npm ci || npm install
            
            # –°–±–æ—Ä–∫–∞
            npm run build
            
            # –ú–∏–≥—Ä–∞—Ü–∏–∏
            npm run migrate:up || echo "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã"
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
            if command -v pm2 &> /dev/null; then
              pm2 restart kamchatour-hub || pm2 start ecosystem.config.js
              pm2 save
            fi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω"
          ENDSSH
