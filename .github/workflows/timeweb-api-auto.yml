name: ‚ö° Auto Deploy via Timeweb API

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Timeweb API
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ
        env:
          TIMEWEB_TOKEN: ${{ secrets.TIMEWEB_TOKEN1 }}
        run: |
          echo "üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ Timeweb API..."
          
          if [ -z "$TIMEWEB_TOKEN" ]; then
            echo "‚ùå TIMEWEB_TOKEN1 –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ GitHub Secrets!"
            exit 1
          fi
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ jq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
          sudo apt-get update
          sudo apt-get install -y jq curl
          
          # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
          RESPONSE=$(curl -s -H "Authorization: Bearer $TIMEWEB_TOKEN" \
            https://api.timeweb.cloud/api/v1/servers)
          
          echo "üìä –û—Ç–≤–µ—Ç API:"
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
          
          # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –ø–µ—Ä–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
          SERVER_IP=$(echo "$RESPONSE" | jq -r '.servers[0].ip // .servers[0].external_ip // empty')
          SERVER_ID=$(echo "$RESPONSE" | jq -r '.servers[0].id // empty')
          
          if [ -z "$SERVER_IP" ]; then
            echo "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —á–µ—Ä–µ–∑ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π SSH –¥–µ–ø–ª–æ–π"
            SERVER_IP="5.129.248.224"
            echo "TIMEWEB_SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
            echo "TIMEWEB_USE_SSH=true" >> $GITHUB_ENV
          else
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–∞–π–¥–µ–Ω: $SERVER_IP (ID: $SERVER_ID)"
            echo "TIMEWEB_SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
            echo "TIMEWEB_SERVER_ID=$SERVER_ID" >> $GITHUB_ENV
            echo "TIMEWEB_USE_SSH=true" >> $GITHUB_ENV
          fi

      - name: üì¶ Install sshpass
        if: env.TIMEWEB_USE_SSH == 'true'
        run: |
          sudo apt-get install -y sshpass

      - name: üöÄ –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ SSH
        if: env.TIMEWEB_USE_SSH == 'true'
        env:
          SSH_HOST: ${{ env.TIMEWEB_SERVER_IP }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
          PROJECT_DIR: /var/www/kamhub
        run: |
          echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ $SSH_USER@$SSH_HOST:$SSH_PORT"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
          if [ -z "$SSH_PASSWORD" ]; then
            echo "‚ö†Ô∏è SSH –ø–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
          fi
          
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
          DEPLOY_SCRIPT=$(cat << 'DEPLOY_EOF'
          #!/bin/bash
          set -e
          PROJECT_DIR="${1:-/var/www/kamhub}"
          cd "$PROJECT_DIR" || { mkdir -p "$PROJECT_DIR" && cd "$PROJECT_DIR"; }
          
          if [ -d .git ]; then
            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master || true
            git clean -fd
          fi
          
          if [ ! -f package.json ]; then
            echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          npm ci || npm install
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤..."
          npm run type-check || echo "‚ö†Ô∏è Type check failed"
          
          echo "üèóÔ∏è –°–±–æ—Ä–∫–∞..."
          npm run build
          
          echo "üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏..."
          npm run migrate:up || echo "‚ö†Ô∏è Migrations failed"
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
          if command -v pm2 &> /dev/null; then
            if pm2 list | grep -q "kamchatour-hub"; then
              pm2 restart kamchatour-hub --update-env
            else
              [ -f ecosystem.config.js ] && pm2 start ecosystem.config.js || pm2 start npm --name kamchatour-hub -- start
              pm2 save
            fi
          else
            pkill -f "node.*kamhub" || true
            nohup npm start > /var/log/kamhub.log 2>&1 &
          fi
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          DEPLOY_EOF
          )
          
          # –û—Ç–ø—Ä–∞–≤–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
          echo "$DEPLOY_SCRIPT" | sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "cat > /tmp/deploy.sh && chmod +x /tmp/deploy.sh && bash /tmp/deploy.sh '$PROJECT_DIR' && rm /tmp/deploy.sh"

      - name: ‚úÖ Health Check
        if: env.TIMEWEB_USE_SSH == 'true'
        env:
          SERVER_IP: ${{ env.TIMEWEB_SERVER_IP }}
        run: |
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è..."
          sleep 5
          curl -f "http://$SERVER_IP:3000/api/health" && echo "‚úÖ Health OK" || echo "‚ö†Ô∏è Health check failed"

      - name: üìä Summary
        if: always()
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "üåê –°–µ—Ä–≤–µ—Ä: ${{ env.TIMEWEB_SERVER_IP }}"
          echo "üîó URL: http://${{ env.TIMEWEB_SERVER_IP }}:3000"
