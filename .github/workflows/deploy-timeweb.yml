name: Deploy to Timeweb VPS

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches:
      - main
      - cursor/deep-repository-scan-05bf

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TIMEWEB_SSH_KEY }}" > ~/.ssh/timeweb_key
          chmod 600 ~/.ssh/timeweb_key
          ssh-keyscan -H 5.129.248.224 >> ~/.ssh/known_hosts

      - name: üöÄ Deploy to Timeweb VPS
        env:
          SERVER_IP: 5.129.248.224
          SERVER_USER: root
        run: |
          ssh -i ~/.ssh/timeweb_key $SERVER_USER@$SERVER_IP << 'ENDSSH'
            set -e
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
            if ! command -v node &> /dev/null; then
                echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
                apt-get install -y nodejs
            fi
            echo "‚úÖ Node.js: $(node --version)"
            
            # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
            if ! command -v psql &> /dev/null; then
                echo "üóÑÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL..."
                apt-get update -qq
                apt-get install -y postgresql postgresql-contrib
                systemctl enable postgresql
                systemctl start postgresql
            fi
            echo "‚úÖ PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            
            # 3. –°–æ–∑–¥–∞–Ω–∏–µ –ë–î
            echo "üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
            sudo -u postgres psql << 'EOF'
DROP DATABASE IF EXISTS kamhub_production;
DROP USER IF EXISTS kamhub;
CREATE USER kamhub WITH PASSWORD 'kamhub2024secure';
CREATE DATABASE kamhub_production OWNER kamhub;
GRANT ALL PRIVILEGES ON DATABASE kamhub_production TO kamhub;
\q
EOF
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞"
            
            # 4. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞..."
            apt-get install -y git
            mkdir -p /var/www
            cd /var/www
            
            if [ -d "kamhub" ]; then
                cd kamhub
                git fetch origin
                git reset --hard origin/main
                git pull origin main
            else
                git clone https://github.com/PosPk/kamhub.git kamhub
                cd kamhub
            fi
            echo "‚úÖ –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω"
            
            # 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            cat > .env.production << 'ENVEOF'
DATABASE_URL=postgresql://kamhub:kamhub2024secure@localhost:5432/kamhub_production
DATABASE_SSL=false
DATABASE_MAX_CONNECTIONS=20
NODE_ENV=production
PORT=3000
NEXT_PUBLIC_APP_URL=http://5.129.248.224
JWT_SECRET=kamhub-jwt-secret-production-2024
JWT_EXPIRES_IN=7d
S3_ENDPOINT=https://s3.twcstorage.ru
S3_BUCKET=d9542536-676ee691-7f59-46bb-bf0e-ab64230eec50
S3_ACCESS_KEY=F2CP4X3X17GVQ1YH5I5D
S3_SECRET_KEY=72iAsYR4QQCIdaDI9e9AzXnzVvvP8bvPELmrBVzX
S3_REGION=ru-1
ENVEOF
            chmod 600 .env.production
            echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
            
            # 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            npm install --production=false
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            
            # 7. –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            npm run build
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ"
            
            # 8. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
            echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
            export PGPASSWORD='kamhub2024secure'
            psql -h localhost -U kamhub -d kamhub_production -f lib/database/schema.sql || echo "Schema already exists"
            psql -h localhost -U kamhub -d kamhub_production -f lib/database/tour_system_schema.sql || echo "Tour schema already exists"
            psql -h localhost -U kamhub -d kamhub_production -f lib/database/user_roles_migration.sql || echo "User roles already migrated"
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞"
            
            # 9. PM2
            echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PM2..."
            if ! command -v pm2 &> /dev/null; then
                npm install -g pm2
            fi
            
            pm2 delete kamhub 2>/dev/null || true
            
            cat > ecosystem.config.js << 'PM2EOF'
module.exports = {
  apps: [{
    name: 'kamhub',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    cwd: '/var/www/kamhub',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    autorestart: true,
    max_memory_restart: '1G',
    error_file: '/var/log/kamhub-error.log',
    out_file: '/var/log/kamhub-out.log'
  }]
};
PM2EOF
            
            pm2 start ecosystem.config.js
            pm2 save
            pm2 startup systemd -u root --hp /root
            echo "‚úÖ PM2 –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"
            
            # 10. Nginx
            echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
            if ! command -v nginx &> /dev/null; then
                apt-get install -y nginx
                systemctl enable nginx
            fi
            
            cat > /etc/nginx/sites-available/kamhub << 'NGINXEOF'
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name 5.129.248.224;
    
    client_max_body_size 50M;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
NGINXEOF
            
            ln -sf /etc/nginx/sites-available/kamhub /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default
            
            nginx -t && systemctl restart nginx
            echo "‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            sleep 5
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω: http://5.129.248.224"
            echo ""
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
            pm2 status
            echo ""
            echo "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:"
            echo "  pm2 logs kamhub    - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
            echo "  pm2 restart kamhub - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
            echo "  pm2 stop kamhub    - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞"
            echo ""
          ENDSSH

      - name: ‚úÖ Deployment Complete
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë              ‚úÖ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù!                          ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üåê –°–∞–π—Ç: http://5.129.248.224"
          echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
          echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://5.129.248.224"
          echo "   2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å /auth/register-business"
          echo "   3. –ù–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ!"
