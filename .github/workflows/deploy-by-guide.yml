name: üöÄ Deploy following DEPLOY_GUIDE_FULL.md

on:
  push:
    branches:
      - main
      - master
      - cursor/**
  workflow_dispatch:

jobs:
  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –ø–æ DEPLOY_GUIDE_FULL.md
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Install sshpass and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass curl jq

      - name: üìñ –ß—Ç–µ–Ω–∏–µ DEPLOY_GUIDE_FULL.md —Å —Å–µ—Ä–≤–µ—Ä–∞
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
        run: |
          echo "üìñ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ —á—Ç–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          if ! sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "echo 'Connected'"; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
            exit 1
          fi
          
          # –ß—Ç–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
          echo "üìã –ß–∏—Ç–∞—é DEPLOY_GUIDE_FULL.md..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "cat /var/www/kamhub/DEPLOY_GUIDE_FULL.md 2>/dev/null || cat /var/www/kamchatour-hub/DEPLOY_GUIDE_FULL.md 2>/dev/null" > /tmp/DEPLOY_GUIDE.md
          
          if [ -s /tmp/DEPLOY_GUIDE.md ]; then
            echo "‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞!"
            echo "üìÑ –ü–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫:"
            head -100 /tmp/DEPLOY_GUIDE.md
          else
            echo "‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É"
          fi

      - name: üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
        run: |
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è..."
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'ENDSSH'
            set -e
            
            echo "üìñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
            INSTRUCTIONS_FILE=""
            
            if [ -f /var/www/kamhub/DEPLOY_GUIDE_FULL.md ]; then
              INSTRUCTIONS_FILE="/var/www/kamhub/DEPLOY_GUIDE_FULL.md"
              APP_DIR="/var/www/kamhub"
            elif [ -f /var/www/kamchatour-hub/DEPLOY_GUIDE_FULL.md ]; then
              INSTRUCTIONS_FILE="/var/www/kamchatour-hub/DEPLOY_GUIDE_FULL.md"
              APP_DIR="/var/www/kamchatour-hub"
            fi
            
            if [ -n "$INSTRUCTIONS_FILE" ]; then
              echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: $INSTRUCTIONS_FILE"
              echo "üìã –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:"
              head -20 "$INSTRUCTIONS_FILE"
              echo ""
              echo "üìã –°–õ–ï–î–£–Æ –ò–ù–°–¢–†–£–ö–¶–ò–ò –ò–ó DEPLOY_GUIDE_FULL.md"
            else
              echo "‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É"
              APP_DIR="/var/www/kamhub"
            fi
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            if [ ! -d "$APP_DIR" ]; then
              echo "üì• –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –∫–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
              mkdir -p /var/www
              cd /var/www
              git clone https://github.com/PosPk/kamhub.git kamhub
              cd kamhub
            else
              echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
              cd "$APP_DIR"
              if [ -d .git ]; then
                git fetch origin
                CURRENT_BRANCH=$(git branch --show-current || echo "main")
                git reset --hard origin/$CURRENT_BRANCH || git reset --hard origin/main || true
                git clean -fd
              else
                echo "‚ö†Ô∏è .git –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º..."
                cd /var/www
                rm -rf kamhub
                git clone https://github.com/PosPk/kamhub.git kamhub
                cd kamhub
              fi
            fi
            
            echo "üì¶ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $(pwd)"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json
            if [ ! -f package.json ]; then
              echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              ls -la
              exit 1
            fi
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            echo "üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤..."
            npm run type-check || echo "‚ö†Ô∏è Type check failed, continuing..."
            
            # –°–±–æ—Ä–∫–∞
            echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            npm run build
            
            # –ú–∏–≥—Ä–∞—Ü–∏–∏
            echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
            npm run migrate:up || echo "‚ö†Ô∏è Migrations failed, continuing..."
            
            # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
            echo "üîÑ –ó–∞–ø—É—Å–∫/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2..."
            if command -v pm2 &> /dev/null; then
              if pm2 list | grep -q "kamchatour-hub"; then
                pm2 restart kamchatour-hub --update-env
                echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
              else
                if [ -f ecosystem.config.js ]; then
                  pm2 start ecosystem.config.js
                else
                  pm2 start npm --name kamchatour-hub -- start
                fi
                pm2 save
                echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"
              fi
              pm2 list
            else
              echo "‚ö†Ô∏è PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é..."
              pkill -f "node.*kamhub" || true
              nohup npm start > /var/log/kamhub.log 2>&1 &
            fi
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          ENDSSH

      - name: ‚úÖ Health Check
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}
        run: |
          echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è..."
          sleep 5
          curl -f "http://$SSH_HOST:3000/api/health" && echo "‚úÖ OK" || echo "‚ö†Ô∏è Health check failed"

      - name: üìä Summary
        if: always()
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω!"
          echo "üåê –°–µ—Ä–≤–µ—Ä: ${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}"
          echo "üîó URL: http://${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}:3000"
