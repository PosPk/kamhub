name: üöÄ Deploy to Timeweb VDS

on:
  push:
    branches:
      - main
      - master
      - cursor/**
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    name: Deploy to Timeweb VDS
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TIMEWEB_SSH_KEY }}
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ sshpass

      - name: üì¶ Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: üöÄ Deploy to server
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
        run: |
          echo "üöÄ Starting deployment to $SSH_USER@$SSH_HOST:$SSH_PORT"
          
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
          cat > deploy-remote.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "üì¶ Updating application..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd /var/www/kamhub || cd /root/kamhub || {
            echo "‚ùå Project directory not found, creating..."
            mkdir -p /var/www/kamhub
            cd /var/www/kamhub
          }
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
          if [ -d .git ]; then
            echo "üîÑ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          else
            echo "‚ö†Ô∏è Git not found, skipping git pull"
          fi
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          echo "üìö Installing dependencies..."
          npm ci --production=false
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          echo "üîç Type checking..."
          npm run type-check || echo "‚ö†Ô∏è Type check failed, continuing..."
          
          # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "üèóÔ∏è Building application..."
          npm run build
          
          # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if [ -f "scripts/migrate.ts" ] || [ -f "package.json" ] && grep -q "migrate" package.json; then
            echo "üóÑÔ∏è Running database migrations..."
            npm run migrate:up || echo "‚ö†Ô∏è Migrations failed, continuing..."
          fi
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "üîÑ Restarting application..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å-–º–µ–Ω–µ–¥–∂–µ—Ä
          if command -v pm2 &> /dev/null; then
            echo "üì¶ Using PM2..."
            pm2 restart kamhub || pm2 start ecosystem.config.js --name kamhub
            pm2 save
          elif [ -f "package.json" ] && grep -q "\"start\"" package.json; then
            echo "üì¶ Using systemd or direct start..."
            # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è systemd
            systemctl restart kamhub || systemctl start kamhub || {
              echo "‚ö†Ô∏è systemd not found, starting directly..."
              nohup npm start > /var/log/kamhub.log 2>&1 &
            }
          else
            echo "‚ö†Ô∏è No process manager found, starting directly..."
            nohup npm start > /var/log/kamhub.log 2>&1 &
          fi
          
          echo "‚úÖ Deployment completed!"
          DEPLOY_SCRIPT
          
          # –ü–µ—Ä–µ–¥–∞—á–∞ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" deploy-remote.sh "$SSH_USER@$SSH_HOST:/tmp/deploy-remote.sh"
          
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'ENDSSH'
            chmod +x /tmp/deploy-remote.sh
            bash /tmp/deploy-remote.sh
            rm /tmp/deploy-remote.sh
          ENDSSH

      - name: ‚úÖ Deployment successful
        run: |
          echo "‚úÖ Successfully deployed to Timeweb VDS!"
          echo "üåê Your application should be available at:"
          echo "   http://${{ secrets.TIMEWEB_SSH_HOST }}"
