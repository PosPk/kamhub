name: ๐ Auto Deploy to Timeweb VDS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: ๐ Deploy to Timeweb VDS
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4

      - name: ๐ฆ Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: ๐ ะะพะปััะตะฝะธะต IP ัะตัะฒะตัะฐ ัะตัะตะท Timeweb API
        env:
          TIMEWEB_TOKEN: ${{ secrets.TIMEWEB_TOKEN1 }}
        run: |
          echo "๐ ะะพะปััะตะฝะธะต IP ัะตัะฒะตัะฐ ัะตัะตะท Timeweb API..."
          
          if [ -z "$TIMEWEB_TOKEN" ]; then
            echo "โ๏ธ TIMEWEB_TOKEN1 ะฝะต ะฝะฐะนะดะตะฝ, ะธัะฟะพะปัะทัะตะผ ะฟััะผะพะน SSH"
            echo "TIMEWEB_SSH_HOST=${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}" >> $GITHUB_ENV
          else
            sudo apt-get update && sudo apt-get install -y jq curl
            
            RESPONSE=$(curl -s -H "Authorization: Bearer $TIMEWEB_TOKEN" \
              https://api.timeweb.cloud/api/v1/servers)
            
            SERVER_IP=$(echo "$RESPONSE" | jq -r '.servers[0].ip // .servers[0].external_ip // empty')
            
            if [ -n "$SERVER_IP" ]; then
              echo "โ IP ะฟะพะปััะตะฝ ัะตัะตะท API: $SERVER_IP"
              echo "TIMEWEB_SSH_HOST=$SERVER_IP" >> $GITHUB_ENV
            else
              echo "โ๏ธ IP ะฝะต ะฟะพะปััะตะฝ ัะตัะตะท API, ะธัะฟะพะปัะทัะตะผ ะฟััะผะพะน SSH"
              echo "TIMEWEB_SSH_HOST=${{ secrets.TIMEWEB_SSH_HOST || '5.129.248.224' }}" >> $GITHUB_ENV
            fi
          fi

      - name: ๐ Test SSH Connection
        env:
          SSH_HOST: ${{ env.TIMEWEB_SSH_HOST }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER || 'root' }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
        run: |
          if [ -z "$SSH_HOST" ] || [ -z "$SSH_USER" ] || [ -z "$SSH_PASSWORD" ]; then
            echo "โ GitHub Secrets ะฝะต ะฝะฐัััะพะตะฝั!"
            echo "ะะฐัััะพะนัะต ัะตะบัะตัั: TIMEWEB_SSH_HOST, TIMEWEB_SSH_USER, TIMEWEB_SSH_PASSWORD"
            exit 1
          fi
          
          echo "โ ะกะตะบัะตัั ะฝะฐะนะดะตะฝั"
          echo "Host: $SSH_HOST"
          echo "User: $SSH_USER"

      - name: ๐ Deploy to server
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST }}
          SSH_USER: ${{ secrets.TIMEWEB_SSH_USER }}
          SSH_PASSWORD: ${{ secrets.TIMEWEB_SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.TIMEWEB_SSH_PORT || '22' }}
          PROJECT_DIR: /var/www/kamhub
        run: |
          echo "๐ ะะฐัะฐะปะพ ะดะตะฟะปะพั ะฝะฐ $SSH_USER@$SSH_HOST:$SSH_PORT"
          
          # ะกะพะทะดะฐะตะผ ัะบัะธะฟั ะดะตะฟะปะพั
          cat > /tmp/deploy-remote.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          
          PROJECT_DIR="${1:-/var/www/kamhub}"
          
          echo "๐ฆ ะะฑะฝะพะฒะปะตะฝะธะต ะฟัะธะปะพะถะตะฝะธั ะฒ $PROJECT_DIR"
          
          # ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะตัะปะธ ะฝะตั
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          
          # ะัะปะธ ััะพ ะฟะตัะฒัะน ัะฐะท ะธ ะฝะตั .git - ะบะปะพะฝะธััะตะผ ัะตะฟะพะทะธัะพัะธะน
          if [ ! -d .git ]; then
            echo "๐ฅ ะะตัะฒัะน ะดะตะฟะปะพะน: ะบะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั..."
            cd /var/www
            rm -rf kamhub
            git clone https://github.com/PosPk/kamhub.git kamhub
            cd kamhub
          else
            echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท Git..."
            git fetch origin
            CURRENT_BRANCH=$(git branch --show-current || echo "main")
            git reset --hard origin/$CURRENT_BRANCH || git reset --hard origin/main || git reset --hard origin/master
            git clean -fd
          fi
          
          # ะัะพะฒะตัะบะฐ package.json
          if [ ! -f package.json ]; then
            echo "โ package.json ะฝะต ะฝะฐะนะดะตะฝ ะฟะพัะปะต ะบะปะพะฝะธัะพะฒะฐะฝะธั!"
            echo "ะะธัะตะบัะพัะธั: $(pwd)"
            echo "ะกะพะดะตัะถะธะผะพะต:"
            ls -la
            exit 1
          fi
          
          # ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
          echo "๐ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
          # ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ (ะฝะต ะฑะปะพะบะธััะตั)
          echo "๐ ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ..."
          npm run type-check || echo "โ๏ธ Type check failed, continuing..."
          
          # ะกะฑะพัะบะฐ
          echo "๐๏ธ ะกะฑะพัะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
          npm run build
          
          # ะะธะณัะฐัะธะธ (ะฝะต ะฑะปะพะบะธััะตั)
          echo "๐๏ธ ะัะธะผะตะฝะตะฝะธะต ะผะธะณัะฐัะธะน..."
          npm run migrate:up || echo "โ๏ธ Migrations failed, continuing..."
          
          # ะะตัะตะทะฐะฟััะบ ัะตัะตะท PM2
          echo "๐ ะะตัะตะทะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั..."
          if command -v pm2 &> /dev/null; then
            if pm2 list | grep -q "kamchatour-hub"; then
              pm2 restart kamchatour-hub --update-env
              echo "โ ะัะธะปะพะถะตะฝะธะต ะฟะตัะตะทะฐะฟััะตะฝะพ ัะตัะตะท PM2"
            else
              if [ -f ecosystem.config.js ]; then
                # ะฃะฑะตะถะดะฐะตะผัั ััะพ ะฟะพัั 8080
                sed -i 's/PORT: 3000/PORT: 8080/g' ecosystem.config.js || true
                pm2 start ecosystem.config.js
              else
                PORT=8080 pm2 start npm --name kamchatour-hub -- start
              fi
              pm2 save
              echo "โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ัะตัะตะท PM2 ะฝะฐ ะฟะพััั 8080"
            fi
            pm2 list
          else
            echo "โ๏ธ PM2 ะฝะต ัััะฐะฝะพะฒะปะตะฝ, ะทะฐะฟััะบะฐะตะผ ะฝะฐะฟััะผัั ะฝะฐ ะฟะพััั 8080..."
            pkill -f "node.*kamhub" || true
            PORT=8080 nohup npm start > /var/log/kamhub.log 2>&1 &
            echo "โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ะฝะฐ ะฟะพััั 8080 (PID: $!)"
          fi
          
          echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
          DEPLOY_SCRIPT
          
          # ะะตัะตะดะฐะตะผ ัะบัะธะฟั ะฝะฐ ัะตัะฒะตั
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P "$SSH_PORT" /tmp/deploy-remote.sh "$SSH_USER@$SSH_HOST:/tmp/deploy-remote.sh"
          
          # ะัะฟะพะปะฝัะตะผ ะฝะฐ ัะตัะฒะตัะต
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << ENDSSH
            chmod +x /tmp/deploy-remote.sh
            bash /tmp/deploy-remote.sh "$PROJECT_DIR"
            rm /tmp/deploy-remote.sh
          ENDSSH

      - name: โ Health Check
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST }}
        run: |
          echo "๐ฅ ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ะฟัะธะปะพะถะตะฝะธั..."
          sleep 5
          
          if [ -n "$SSH_HOST" ]; then
            if curl -f -s "http://$SSH_HOST:8080/api/health" > /dev/null 2>&1; then
              echo "โ Health check passed (ะฟััะผะพะน ะดะพัััะฟ ะฝะฐ 8080)!"
            elif curl -f -s "http://$SSH_HOST/api/health" > /dev/null 2>&1; then
              echo "โ Health check passed (ัะตัะตะท Nginx)!"
            else
              echo "โ๏ธ Health check failed (ะฒะพะทะผะพะถะฝะพ ัะตัะฒะตั ะตัะต ะทะฐะฟััะบะฐะตััั)"
            fi
          fi

      - name: ๐ Deployment Summary
        env:
          SSH_HOST: ${{ secrets.TIMEWEB_SSH_HOST }}
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ ะะะะะะ ะะะะะะจะะ!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ ะะตะฟะพะทะธัะพัะธะน: ${{ github.repository }}"
          echo "๐ฟ ะะตัะบะฐ: ${{ github.ref_name }}"
          echo "๐ฌ ะะพะผะผะธั: ${{ github.sha }}"
          echo "๐ค ะะฒัะพั: ${{ github.actor }}"
          if [ -n "$SSH_HOST" ]; then
            echo "๐ ะกะตัะฒะตั: $SSH_HOST"
            echo "๐ ะััะผะพะน ะดะพัััะฟ: http://$SSH_HOST:8080"
            echo "๐ ะงะตัะตะท Nginx: http://$SSH_HOST"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
