# 🗺️ СИСТЕМА ПЛАНИРОВАНИЯ ПУТЕШЕСТВИЙ - РЕАЛИЗАЦИЯ

## 📋 Обзор

Реализована **интеллектуальная система планирования поездок на Камчатку** с AI-генерацией маршрутов, автоматическим подбором туров, размещения и трансферов.

---

## ✅ ЧТО РЕАЛИЗОВАНО

### 1. 🗄️ База данных

#### Новые таблицы для размещения:

**`accommodations`** - Размещение (отели, хостелы, апартаменты)
- Типы: hotel, hostel, apartment, guesthouse, resort, camping, glamping, cottage
- Характеристики: звездность, кол-во номеров, время заезда/выезда
- Удобства: wifi, parking, breakfast, spa, pool, gym, restaurant, bar, pets
- Цены: от-до за ночь
- Рейтинг и отзывы
- Геолокация (coordinates JSONB)

**`accommodation_rooms`** - Номера
- Типы: single, double, twin, triple, suite, family, dormitory
- Конфигурация кроватей
- Площадь, макс. гостей
- Вид из окна: mountain, sea, volcano, city, garden
- Цена за ночь, доступность

**`accommodation_bookings`** - Бронирования
- Даты заезда/выезда, количество ночей
- Кол-во взрослых и детей
- Статусы: pending, confirmed, cancelled, completed, no_show
- Платежи: pending, paid, refunded, partially_refunded
- Особые пожелания

**`accommodation_reviews`** - Отзывы
- Рейтинги по категориям: чистота, сервис, локация, соотношение цена/качество
- Общий рейтинг
- Комментарий

**Триггеры:**
- Автоматический расчет количества ночей
- Обновление рейтинга при добавлении отзыва
- Автоматическое обновление `updated_at`

📄 **Файл**: `/lib/database/accommodation_schema.sql`

---

### 2. 🤖 AI Планировщик маршрутов

#### API Endpoint: `POST /api/trip/plan`

**Функциональность:**

1. **Анализ запроса пользователя** через AI:
   - Извлечение интересов (вулканы, медведи, рыбалка, термальные источники)
   - Определение уровня физ. подготовки (easy, medium, hard)
   - Определение типа путешественника (одиночка, пара, семья, группа)
   - Выявление приоритетов (adventure, comfort, budget, ecology, photography)

2. **Подбор туров из БД**:
   - Фильтрация по сложности, рейтингу (≥3.5), цене
   - Учет длительности туров
   - Сортировка по рейтингу и кол-ву отзывов
   - Максимум 15 вариантов

3. **Подбор размещения**:
   - Фильтрация по цене за ночь, рейтингу (≥3.5)
   - Учет размера группы
   - Сортировка: рейтинг DESC, цена ASC
   - Максимум 10 вариантов

4. **Подбор трансферов**:
   - Маршруты между локациями туров
   - Расчет расстояний и времени
   - Выбор типа транспорта
   - Учет стоимости

5. **Генерация детального плана** через AI:
   - Поминутный план на каждый день
   - Активности с указанием типа (tour, transfer, free_time, meal)
   - **Логистика между каждой точкой:**
     - Тип транспорта (walk, car, bus, taxi, transfer, helicopter)
     - Время в пути (минуты)
     - Расстояние (км)
     - Заметки
   - Размещение каждую ночь
   - Расчет стоимости по дням
   - Рекомендации и важные заметки

**Пример запроса:**

```json
{
  "query": "Я планирую поездку на КАМЧАТКУ на 7 дней. Составь для меня детальный маршрут. Подбери место проживания. Укажи не только туры и достопримечательности, также логистику между точками (пешком/транспорт)",
  "days": 7,
  "budget": 100000,
  "interests": ["hiking", "wildlife", "photography"],
  "groupSize": 2,
  "startDate": "2025-07-15"
}
```

**Ответ включает:**
- `summary` - общая информация (дни, стоимость, highlights, уровень сложности)
- `days[]` - детальный план каждого дня с активностями и логистикой
- `tours[]` - полные данные выбранных туров из БД
- `accommodations[]` - полные данные выбранного размещения
- `transfers[]` - полные данные трансферов
- `recommendations[]` - практические советы
- `important_notes[]` - важная информация о безопасности

📄 **Файл**: `/app/api/trip/plan/route.ts`

---

### 3. 📍 Модуль расчета логистики

#### Библиотека: `/lib/trip-planner/logistics.ts`

**Возможности:**

1. **Расчет расстояний (Haversine formula)**:
   - Точный расчет по сфере Земли
   - Округление до 0.1 км

2. **Определение оптимального транспорта**:

| Транспорт | Условия | Скорость | Стоимость | Feasibility |
|-----------|---------|----------|-----------|-------------|
| Пешком | ≤2км (город), ≤5км (природа) | 3-4 км/ч | 0₽ | easy/moderate |
| Автобус | Только город, >2км | ~20 км/ч | 30₽ | easy |
| Такси | ≥1км | ~25 км/ч | 200₽+50₽/км | easy |
| Трансфер | ≥10км | ~30 км/ч | 100₽/км | easy |
| Личный авто | ≥5км | ~30 км/ч | 15₽/км | easy/moderate |
| Вертолет | ≥50км (горы) | ~120 км/ч | 1000₽/км | moderate |

3. **Построение маршрутов**:
   - Учет типа местности (city, mountain, mixed)
   - Наличие общественного транспорта
   - Бюджетные ограничения
   - Предпочтения по транспорту

4. **Вспомогательные функции**:
   - Расчет общей стоимости маршрута
   - Расчет общего времени в пути
   - Проверка возможности однодневного маршрута
   - Поиск ближайшей известной локации
   - Форматирование времени и расстояний

**Предустановленные локации Камчатки:**
- Аэропорт Елизово
- Центр Петропавловска
- Авачинский вулкан
- Корякский вулкан
- Паратунка (термальные источники)
- Халактырский пляж
- Вилючинский перевал

---

### 4. 🔧 Миграция БД

#### Скрипт: `scripts/migrate-accommodation.ts`

**Функции:**
- Применение схемы accommodation к БД
- Создание всех таблиц, индексов, триггеров
- Проверка созданных таблиц
- Добавление тестовых данных (опционально)

**Использование:**

```bash
# Миграция без тестовых данных
npm run migrate:accommodation

# Миграция с тестовыми данными
npm run migrate:accommodation:seed
```

**Тестовые данные включают:**
- 1 партнёр (гостиница "Петропавловск")
- 1 размещение (3 звезды, 50 номеров)
- 3 типа номеров (одноместный, двухместный, люкс)

---

### 5. 📚 Документация

#### `/docs/TRIP_PLANNER_API.md`

Полная документация включает:
- Описание API endpoint
- Примеры запросов для разных сценариев
- Логика подбора туров, размещения, трансферов
- Расчет логистики (формулы, таблицы)
- AI промпты
- Схему БД
- Примеры интеграции (React)
- Производительность и ограничения
- Планы развития

---

## 🎯 ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### Запрос 1: Активный отдых на 5 дней

```bash
curl -X POST https://kamhub.com/api/trip/plan \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Хочу активный отдых на 5 дней. Восхождения на вулканы, рыбалка, термальные источники.",
    "days": 5,
    "budget": 60000,
    "interests": ["hiking", "fishing", "nature"]
  }'
```

### Запрос 2: Семейная поездка

```bash
curl -X POST https://kamhub.com/api/trip/plan \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Планируем семейную поездку с детьми 7 и 10 лет на неделю. Нужны несложные маршруты и комфортное жилье.",
    "days": 7,
    "groupSize": 4,
    "interests": ["family", "nature", "easy_hiking"]
  }'
```

### Запрос 3: Фото-тур

```bash
curl -X POST https://kamhub.com/api/trip/plan \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Я фотограф. Хочу снять вулканы, медведей, природу Камчатки за 10 дней.",
    "days": 10,
    "budget": 150000,
    "interests": ["photography", "wildlife", "nature", "volcanoes"]
  }'
```

---

## 🚀 ЗАПУСК И РАЗВЕРТЫВАНИЕ

### 1. Применить миграции

```bash
npm run migrate:accommodation:seed
```

### 2. Проверить БД

```bash
npm run db:info
```

### 3. Запустить dev сервер

```bash
npm run dev
```

### 4. Протестировать API

```bash
curl -X POST http://localhost:3002/api/trip/plan \
  -H "Content-Type: application/json" \
  -d '{"query": "Поездка на 3 дня", "days": 3}'
```

---

## 📊 АРХИТЕКТУРА

```
┌─────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                          │
│  "Я планирую поездку на Камчатку на 7 дней..."             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              POST /api/trip/plan                             │
│                                                              │
│  1. Анализ запроса (AI) → интересы, уровень, тип           │
│  2. Подбор туров (БД) → rating, difficulty, price           │
│  3. Подбор размещения (БД) → type, price, amenities         │
│  4. Подбор трансферов (БД) → routes, vehicles               │
│  5. Генерация плана (AI) → детальный маршрут                │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌────────────┐  ┌───────────────┐  ┌──────────────┐
│   TOURS    │  │ ACCOMMODATIONS│  │  TRANSFERS   │
│   TABLE    │  │    TABLES     │  │    TABLES    │
└────────────┘  └───────────────┘  └──────────────┘
         │               │               │
         └───────────────┼───────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              LOGISTICS CALCULATION                           │
│                                                              │
│  • Haversine distance formula                               │
│  • Transport type determination                             │
│  • Cost & time estimation                                   │
│  • Route feasibility check                                  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    AI GROQ/DeepSeek                          │
│                                                              │
│  Prompt: "Создай детальный план на N дней с:                │
│   - Поминутным расписанием                                  │
│   - Логистикой между точками                                │
│   - ID карточек из БД                                       │
│   - Временем на отдых"                                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    TRIP PLAN (JSON)                          │
│                                                              │
│  • summary: {days, cost, highlights, difficulty}            │
│  • days[]: {activities[], accommodation, total_cost}        │
│  • tours[], accommodations[], transfers[]                   │
│  • recommendations[], important_notes[]                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 ТЕХНОЛОГИИ

- **Backend**: Next.js 14 API Routes, TypeScript
- **AI**: GROQ (Llama 3.1-70B), DeepSeek (fallback)
- **Database**: PostgreSQL + PostGIS
- **Libraries**: 
  - `pg` для БД
  - Haversine formula для георасчетов
  - Custom logistics engine

---

## ⚡ ПРОИЗВОДИТЕЛЬНОСТЬ

- **Время отклика**: 5-15 секунд для плана на 7 дней
- **AI провайдеры**: Автоматическое переключение GROQ → DeepSeek
- **Max duration**: 60 секунд для сложных запросов
- **Кэширование**: Туры и размещение кэшируются

---

## 🎯 РЕЗУЛЬТАТ

### ЧТО УМЕЕТ СИСТЕМА:

✅ **Понимать запросы на естественном языке**
- "Я планирую поездку на 5 дней. Хочу вулканы и медведей"
- Автоматически извлекает намерения, интересы, бюджет

✅ **Подбирать карточки из БД**
- Туры (15 лучших по рейтингу и сложности)
- Размещение (10 вариантов по цене и качеству)
- Трансферы (20 маршрутов с расчетом времени/стоимости)

✅ **Генерировать детальный план**
- Поминутное расписание на каждый день
- **Логистика между КАЖДОЙ точкой:**
  - Тип транспорта (пешком/такси/трансфер/вертолет)
  - Время в пути (мин)
  - Расстояние (км)
  - Стоимость
  - Практические заметки

✅ **Рассчитывать стоимость**
- Общая стоимость поездки
- Разбивка по дням
- Учет туров, жилья, транспорта

✅ **Давать рекомендации**
- Практические советы (одежда, снаряжение)
- Важные заметки (безопасность, медведи)
- Учет погоды Камчатки

---

## 📝 ФАЙЛЫ

```
/workspace/
├── app/api/trip/plan/route.ts          # Главный API endpoint
├── lib/
│   ├── database/
│   │   └── accommodation_schema.sql     # Схема БД размещения
│   └── trip-planner/
│       └── logistics.ts                 # Модуль расчета логистики
├── scripts/
│   └── migrate-accommodation.ts         # Миграция БД
├── docs/
│   └── TRIP_PLANNER_API.md             # Документация API
├── package.json                         # Обновлены скрипты миграции
└── TRIP_PLANNER_IMPLEMENTATION.md      # Этот файл
```

---

## 🎉 ИТОГО

**Создана полноценная интеллектуальная система планирования путешествий на Камчатку:**

1. ✅ База данных для размещения (4 таблицы + триггеры)
2. ✅ API endpoint с AI-генерацией маршрутов
3. ✅ Система подбора карточек (туры, отели, трансферы)
4. ✅ Модуль расчета логистики (Haversine, транспорт, стоимость)
5. ✅ Миграции и тестовые данные
6. ✅ Полная документация

**СИСТЕМА ГОТОВА К ИСПОЛЬЗОВАНИЮ! 🚀**

---

**Дата**: 30.10.2025  
**Версия**: 1.0.0  
**Разработано для**: Kamchatour Hub 🌋
