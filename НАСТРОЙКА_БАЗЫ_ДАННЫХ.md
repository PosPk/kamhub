# üóÑÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• PostgreSQL

## ‚úÖ –î–ê–ù–ù–´–ï –ë–î –ü–û–õ–£–ß–ï–ù–´!

```
Host:     45.8.96.120
Port:     5432
User:     gen_user
Password: ******** (—Å–∫—Ä—ã—Ç)
Database: default_db
```

---

## üöÄ –ë–´–°–¢–†–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò)

### –û–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:

```bash
bash scripts/init-database.sh
```

**–°–∫—Ä–∏–ø—Ç —Å–¥–µ–ª–∞–µ—Ç:**
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
2. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (UUID, PostGIS, pg_trgm)
3. ‚úÖ –°–æ–∑–¥–∞—Å—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç –∏–Ω–¥–µ–∫—Å—ã
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–í—Ä–µ–º—è:** ~2-3 –º–∏–Ω—É—Ç—ã

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–ê–†–û–õ–¨ –ë–î

–ü–∞—Ä–æ–ª—å —Å–∫—Ä—ã—Ç –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏ –≤ –≤–∞—à–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.

### –ì–¥–µ –≤–∑—è—Ç—å –ø–∞—Ä–æ–ª—å:

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://timeweb.cloud/my/databases
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à—É –ë–î `default_db`
3. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª—å

### –ö—É–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å:

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `.env.timeweb.local` –∏ –∑–∞–º–µ–Ω–∏—Ç–µ `YOUR_PASSWORD`:

```bash
nano .env.timeweb.local
```

–ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:

```env
DB_PASSWORD=YOUR_PASSWORD
DATABASE_URL=postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db
```

–ó–∞–º–µ–Ω–∏—Ç–µ `YOUR_PASSWORD` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å.

---

## üìã –†–£–ß–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)

### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î

```bash
# –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_PASSWORD –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π!
psql 'postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db'
```

### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Ñ–∞–π–ª—ã –≤ –ø–æ—Ä—è–¥–∫–µ:

```bash
# 1. –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞
psql 'postgresql://...' -f lib/database/schema.sql

# 2. –¢—Ä–∞–Ω—Å—Ñ–µ—Ä—ã
psql 'postgresql://...' -f lib/database/transfer_schema.sql

# 3. –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
psql 'postgresql://...' -f lib/database/loyalty_schema.sql

# 4. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–µ—Å—Ç
psql 'postgresql://...' -f lib/database/seat_holds_schema.sql

# 5. –ü–ª–∞—Ç–µ–∂–∏
psql 'postgresql://...' -f lib/database/transfer_payments_schema.sql

# 6. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
psql 'postgresql://...' -f lib/database/operators_schema.sql

# 7. AI –º–µ—Ç—Ä–∏–∫–∏
psql 'postgresql://...' -f lib/database/ai_metrics_schema.sql
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–æ ~30+ —Ç–∞–±–ª–∏—Ü.

---

## üìä –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| `users` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç—É—Ä–∏—Å—Ç—ã, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, –≥–∏–¥—ã) |
| `tours` | –¢—É—Ä—ã –∏ —ç–∫—Å–∫—É—Ä—Å–∏–∏ |
| `bookings` | –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |
| `transfers` | –¢—Ä–∞–Ω—Å—Ñ–µ—Ä—ã |
| `transfer_bookings` | –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤ |
| `transfer_payments` | –ü–ª–∞—Ç–µ–∂–∏ –∑–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã |
| `loyalty_accounts` | –°—á–µ—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ |
| `loyalty_transactions` | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–ª–ª–æ–≤ |
| `operators` | –¢—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä—ã |
| `operator_licenses` | –õ–∏—Ü–µ–Ω–∑–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ |
| `ai_metrics` | –ú–µ—Ç—Ä–∏–∫–∏ AI –∞–≥–µ–Ω—Ç–∞ |
| `ai_chat_sessions` | –°–µ—Å—Å–∏–∏ AI —á–∞—Ç–∞ |

### –†–∞—Å—à–∏—Ä–µ–Ω–∏—è:

- **uuid-ossp** - UUID –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- **PostGIS** - –ì–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **pg_trgm** - –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

---

## üîß –ù–ê–°–¢–†–û–ô–ö–ê .ENV

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (.env.local):

```env
DATABASE_URL=postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db
```

### Production (.env.production –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ):

```env
DATABASE_URL=postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db
DATABASE_SSL=false
DATABASE_MAX_CONNECTIONS=20
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –ù–ê–°–¢–†–û–ô–ö–ò

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:

```bash
psql 'postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db'
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü:

```sql
\dt
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π:

```sql
\dx
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ë–î:

```sql
SELECT 
    pg_size_pretty(pg_database_size('default_db')) as db_size;
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:

```sql
SELECT count(*) FROM pg_stat_activity 
WHERE datname = 'default_db';
```

---

## üß™ –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï

–°–∫—Ä–∏–ø—Ç `init-database.sh` –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:

| Email | –ü–∞—Ä–æ–ª—å | –†–æ–ª—å |
|-------|--------|------|
| admin@tourhab.ru | admin123 | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä |
| operator@tourhab.ru | admin123 | –¢—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä |
| tourist@tourhab.ru | admin123 | –¢—É—Ä–∏—Å—Ç |

**‚ö†Ô∏è –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ –≤ production!**

---

## üîÑ –ú–ò–ì–†–ê–¶–ò–ò

### –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏:

```bash
# –ü–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏!
pg_dump 'postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db' > backup.sql
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:

```bash
psql 'postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db' < backup.sql
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø:

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–∫—Ä–∏–ø—Ç
bash scripts/backup-database.sh
```

---

## üì± –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î:

1. **–û–±–Ω–æ–≤–∏—Ç–µ .env.production –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**

```bash
ssh root@5.129.248.224

cd /var/www/kamhub

nano .env.production
```

–î–æ–±–∞–≤—å—Ç–µ:

```env
DATABASE_URL=postgresql://gen_user:YOUR_PASSWORD@45.8.96.120:5432/default_db
DATABASE_SSL=false
DATABASE_MAX_CONNECTIONS=20
```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**

```bash
pm2 restart kamhub
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**

```bash
pm2 logs kamhub --lines 50
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
‚úÖ PostgreSQL –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
```

---

## üÜò TROUBLESHOOTING

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** `ECONNREFUSED` –∏–ª–∏ `connection timeout`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
telnet 45.8.96.120 5432

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª –≤ Timeweb
# https://timeweb.cloud/my/databases
```

### –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** `password authentication failed`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å –≤ Timeweb
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ psql –≤—Ä—É—á–Ω—É—é

### –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** `permission denied to create extension`

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫–∞–∫ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
-- –ò–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ Timeweb –≤–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
```

### –¢–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** `relation already exists`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–¥–∞–ª–∏—Ç–µ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
psql '...' -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"

# –ò–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ë–î

### –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```sql
SELECT * FROM pg_stat_activity 
WHERE datname = 'default_db';
```

### –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü:

```sql
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```sql
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î:

1. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   pm2 restart kamhub
   ```

2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ https://tourhab.ru
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
   - –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

3. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±—ç–∫–∞–ø—ã:**
   ```bash
   # –î–æ–±–∞–≤—å—Ç–µ –≤ crontab
   0 2 * * * cd /var/www/kamhub && bash scripts/backup-database.sh
   ```

4. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ —Ä–∞–∑–º–µ—Ä –ë–î
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏

---

## üéâ –ì–û–¢–û–í–û!

### –í–∞—à–∞ –ë–î –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é:**

```bash
bash scripts/init-database.sh
```

**–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã—à–µ.**

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê TIMEWEB

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –ë–î:

- **Dashboard:** https://timeweb.cloud/my/databases
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** https://timeweb.cloud/my/tickets
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://timeweb.cloud/help/databases

---

**–£–¥–∞—á–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π! üöÄ**
