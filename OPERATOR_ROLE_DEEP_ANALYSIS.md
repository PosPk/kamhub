# Туроператор — глубокий анализ и план реализации

Актуально на: 2025-10-16

## 1) Обзор роли и цели
- Основная цель: безопасная и прибыльная организация туров с высокой операционной управляемостью.
- Ключевые KPI: загрузка слотов, маржинальность, SLA коммуникаций, безопасность (инциденты=0), NPS туристов/гидов.

## 2) Основные домены и функции
- Каталог туров: CRUD туров, маршрутов, инвентаря (слоты), прайсинг, сезонность.
- Календарь и планирование: свободные даты/места, быстрое перепланирование.
- CRM: лиды, сделки, клиенты, коммуникации, история.
- Коммуникации и уведомления: гиды, туристы, МЧС/операторы экстренных служб.
- Трансферы и размещение: собственные/партнерские, поиск и бронирование при отсутствии своих мощностей.
- Безопасность: мониторинг погодных/сейсмических/зоологических рисков, протоколы оповещений и изменения маршрутов.
- Геолокация и трекинг: позиция групп/гидов, контроль отклонений, SOS.
- Снаряжение: инвентаризация, аренда/выдача, обязательные требования по маршрутам.
- Страхование: полисы для туристов, верификация/связка с бронями.
- Аналитика и финансы: выручка, маржа, комиссии, выплаты, прогнозирование.

## 3) Модель данных (расширения)
- Organization(operator), OperatorSettings, GuideAssignment, Route, Waypoint, HazardZone, SafetyProtocol.
- Slot (туровые), CapacityAdjustment, OverbookingPolicy, ReassignmentRule.
- Lodging (размещение), Allotment, RatePlan, Availability.
- TransportProvider, TransferAgreement, TransferRequest/Order.
- GearItem, GearInventory, GearRental, GearRequirement (per route).
- InsurancePolicy, InsuranceProvider, CoveragePlan, PolicyAssignment.
- Alert, AlertTemplate, AlertSubscription (гиды/туристы/внешние), EscalationRule.
- TrackingPoint (deviceId, location, timestamp, entity: guide/tourist), Geofence, DeviationEvent.

## 4) Интеграции (референсы)
- Погода: Open-Meteo, Yandex Weather — уже частично есть.
- Сейсмика: USGS/EMSC или локальные источники; RSS/JSON фиды.
- Медведи/опасности: локальные реестры/ручной ввод + краудсорсинг через гидов.
- Трансферы: собственные таблицы + внешние API (Yandex Go и т.п.).
- Размещение: Channel Managers/OTA (PMS, iCal, simple API при MVP — ручные allotments).
- Коммуникации: Email/SMS/Telegram/Push; для МЧС — Email/SMS + шаблоны.
- Страхование: агрегаторы/провайдеры (API для выдачи полисов) — MVP: загрузка PDF/номер полиса.

### Референсы продуктов (best practices)
- Rezdy/PeekPro/Checkfront — B2B2C для туроператоров (слоты, брони, ваучеры, партнёры).
- FareHarbor — календари, мобильные приложения для гидов, интеграции с сайтами.
- TrekkSoft — маршруты, платежи, ваучеры, каналы продаж.
- Yookassa/Stripe — платежные флоу, вебхуки, идемпотентность.
- Twilio/Mailgun/Telegram — омниканальные уведомления и ретраи.

### Варианты и компромиссы (за/против)
- Слоты в одной таблице vs генерация динамически:
  - За таблицу: простые запросы и индексация; Против: рост объёма при длинном горизонте.
  - Решение: хранить явные слоты на 6-12 мес, далее генерация on-demand + материализация по расписанию.
- Инвентарь/овербукинг:
  - За строгие ограничения: меньше инцидентов; Против: потеря конверсии.
  - Решение: политика OverbookingPolicy per-тур с лимитом и автоэскалацией.
- Уведомления как cron vs событийная шина:
  - За шину: масштабируемость, трассировка; Против: сложность.
  - Решение: событийная модель внутри приложения (таблица events) + простая очередь для ретраев.
- Геотрекинг (свой бэкенд vs сторонний):
  - Свой: полный контроль; Против: стоимость и поддержка.
  - Решение: MVP — минимальный ingestion эндпоинт + хранение последних точек, без heavy realtime.
- Размещение (PMS/OTA интеграция) vs manual allotments:
  - PMS: автоматизация; Против: сложные API, сертификация.
  - Решение: MVP — allotments/статусы, iCal поддержка; интеграции позже.

## 8.1) Деплой на Vercel — план
- Секреты: настроить `DATABASE_URL`, API ключи (погода, телеграм), `JWT_SECRET`.
- Runtime: Next.js API маршруты; убедиться, что долгие задачи вынесены в фоновый процесс (или use vercel cron/webhooks).
- БД: управлять миграциями (`lib/database/migrations.ts`). При первом деплое — endpoint для запуска миграций.
- Наблюдаемость: включить Sentry (dsn в env), логирование ошибок API.
- Превью окружения: ветки PR → превью урлы; фича-тогглы через env.

## 5) Пользовательские сценарии (MVP → Scale)
MVP v1 (2-3 недели):
- CRUD туров и маршрутов; слоты и календарь доступности.
- Оперативное уведомление гидов/туристов (Email/Telegram) по событиям.
- Быстрая замена маршрута при рисках: сценарий "перевод" на альтернативный слот/маршрут.
- Поиск внешних трансферов и размещений (заглушки с ручным подтверждением).
- Снаряжение: требования по маршруту + отметка выдачи/возврата (простая инвентаризация).
- Страхование: привязка номера полиса к брони, загрузка документа.

Scale v2:
- Автопланирование смен/назначений гидов.
- Интеграции с Channel Manager для размещения, провайдерами трансферов.
- Геотрекинг в реальном времени, SOS, геозоны и отклонения.
- Сейсмика/фауна — автоматические фиды + машинные правила оповещений.
- CRM полноценная (воронки, задачи, SLA, омниканал).
- Динамическое ценообразование, прогнозирование спроса, отчётность.

## 6) Архитектурные решения
- Событийная модель: Booking/Weather/Seismic/RouteAlert events → Notification service.
- RBAC/ABAC для орг-контекстов (Operator-scoped данные).
- Идемпотентность и транзакции для перепланирования и переводов.
- Геосервисы: геозоны, пересечения маршрутов с HazardZone, триггеры оповещений.
- Поставщик уведомлений с ретраями и журналом.

## 7) Экраны кабинета оператора (UI)
- Дэшборд: KPI, инциденты, задачи.
- Календарь слотов: создание/редактирование, массовые операции.
- Тур/Маршрут: карточка, waypoints, требования, снаряжение.
- Бронирования: список, детали, операции (confirm/cancel/reassign).
- Коммуникации: рассылки, шаблоны, история.
- Трансферы/Размещение: поиск, бронь, подтверждение партнёром.
- Снаряжение: каталог, статусы, выдача/возврат.
- Безопасность: карта рисков, алерты, протоколы.
- Настройки: организация, политики, интеграции.

## 8) MVP план реализации (конкретные шаги)
1. База: таблицы Route/Waypoint/HazardZone/OperatorSettings; слоты; уведомления.
2. API: CRUD туров/маршрутов/слотов; быстрый перевод брони (reassign) и массовые операции по слотам.
3. Уведомления: шаблоны и события (route.alert, route.reassigned, gear.required, weather.warning).
4. Интеграции: заглушки поиска трансфера и размещения (эндпоинты, модальные окна подтверждения).
5. UI кабинет: календарь слотов, бронирования, карточки туров/маршрутов, шаблоны уведомлений.
6. Безопасность: добавление HazardZones, ручной алерт и рассылка, лента инцидентов.

## 9) Риски и меры
- Комплаенс и безопасность локаций — ограничить доступ к точным координатам для публичных ролей.
- Консистентность перепланирования — атомарные операции и оповещения всех сторон.
- Интеграции внешних провайдеров — таймауты, ретраи, деградация до ручного контура.
- Качество данных по рискам — валидация и модерация, краудсорсинг через гидов.

## 10) Метрики
- SLA подтверждения изменений маршрутов.
- Время реакции на погодные/сейсмические алерты.
- Заполненность слотов и отмены.
- Время до брони и конверсия.
- NPS, инциденты, эффективность рассылок.
