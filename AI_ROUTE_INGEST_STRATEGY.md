# AI-план по сбору и нормализации данных маршрутов

Актуально на: 2025-10-16

## Цель
Сформировать большую базу маршрутов по Камчатке (описания, треки/геоданные, метрики, сложности, сезоны, риски) для дальнейшего использования туроператорами/гидами/агентами/трансферами. Внешние фотографии не используем — фото собираем только от наших пользователей.

## Архитектура данных и источники
- Хранилище:
  - Supabase (PostgreSQL + PostGIS, pg_trgm): все каталожные данные маршрутов (без ПДн).
  - Yandex Managed PostgreSQL (152‑ФЗ): пользователи/контакты/аудит — вне данного контура.
- Ключевые таблицы (Supabase): `routes`, `waypoints`, `hazard_zones`, `route_photos` (заполняем только нашими фото), `route_versions`, `route_sources`.
- Источники (первый этап):
  - visitkamchatka.ru/route-passports — оф. паспорта маршрутов
  - idilesom.com/kam/places — каталог мест/маршрутов
- План расширения: GPX/OSM импорты (ручная загрузка), CSV/JSON, другие открытые каталоги.

## Роли ИИ и когда он нужен
- Важно: «выкачка» (HTTP, парсинг HTML, rate-limit, robots) выполняется кодом, НЕ ИИ.
- ИИ используется для:
  - Нормализации и извлечения скрытых полей: `difficulty`, `season[]`, `gear_required[]`, `risk_signals[]` из неструктурированного текста.
  - Кратких резюме/описаний (100–200 слов) для карточек.
  - Верификации дублей на «пограничных» случаях (текстовая близость + гео).
  - Автотегов по тематике (вулканы, водопады, перевалы и т. п.).

## Команда ИИ и распределение задач
- Groq (Llama‑3.1‑70B) — основной провайдер
  - Экстракция полей в строгий JSON (`completeJSON`): сложность/сезон/снаряжение/риски.
  - Резюме текста и автотеги.
- DeepSeek — резерв/алиби-провайдер
  - Дублирование задач Groq при сбоях/неуверенности; работает через тот же контракт JSON.
- OpenRouter — опционально (включим при росте нагрузки или для специфичных моделей)
  - Не обязателен на старте.

## Контракт JSON для экстракции
Запрос через `lib/ai/provider.ts: completeJSON`.
Schema hint (сокращенно):
```
{
  "difficulty": "easy|medium|hard|null",
  "seasons": ["winter|spring|summer|autumn"],
  "gear": ["string"],
  "risks": ["string"],
  "tags": ["string"],
  "summary": "string (<= 700 chars)"
}
```
Вход: сырой текст из карточки + контекст (длина, время, высоты, координаты если есть).
Выход: строго валидный JSON; ошибки — повторный прогон у DeepSeek.

## Оркестрация импорта
- Этапы на источник:
  1) fetch list → 2) fetch page → 3) parse html → 4) normalize метрики/координаты → 5) ИИ‑обогащение (JSON) → 6) dedupe → 7) upsert в `routes`/`waypoints`/… → 8) модерация (pending) → 9) публикация (approved).
- Rate limiting: 1 rps, retry с backoff, кэш (revalidate). User-Agent идентифицирован.
- robots/этика: проверяем `route_sources.robots_checked`; сохраняем `source_url` и атрибуцию.

## Дедупликация и модерация
- Правила дубля: name trigram ≥ 0.6 И расстояние центроидов < 3 км, либо совпадение `import_hash`.
- При «почти дубль»: запись в очередь модерации; ИИ может подсказать вероятность дубля текстом, решение — за человеком.
- Статусы: `pending → approved|rejected|merged` с аудированием.

## Точки интеграции в коде (уже есть/в работе)
- Готово:
  - `lib/ai/provider.ts` (Groq/DeepSeek, strict JSON)
  - Импортеры: `/api/import/routes/visitkamchatka`, `/api/import/routes/idilesom` — без внешних фото
  - Расширенная схема БД под большую базу маршрутов
- В работе:
  - Модерация/дедуп (эндпоинты approve/reject/merge/list) + UI в кабинете оператора
  - Nightly sync (Vercel cron/Webhook + Upstash/QStash)

## Нужны ли дополнительные ИИ‑провайдеры?
- На текущем этапе достаточно Groq + DeepSeek. Подключать дополнительных не требуется.
- Опционально: OpenRouter — резерв для специфических моделей/нагрузки.

## План ближайших шагов (AI‑участие)
1) Встроить ИИ‑обогащение в импортеры (поля difficulty/seasons/gear/risks/tags/summary) с `completeJSON` и fallback.
2) Добавить ИИ‑подсказки для дедупликации (оценка текстовой близости/тематики) — только как рекомендация.
3) Логи/метрики ИИ: доля успешных JSON‑ответов, время отклика, частота фолбэков.

## Доступ и безопасность
- ПДн и личные данные вне контура (Yandex DB). В импорт попадает только открытая информация о маршрутах.
- Храним только текстовые описания, координаты/треки, метрики, без внешних фото.

