# ü§ñ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê POSTGRESQL

> **–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!  
> **–í—Ä–µ–º—è:** 5 –º–∏–Ω—É—Ç  
> **–¢—Ä–µ–±—É–µ—Ç—Å—è:** Connection String –æ—Ç PostgreSQL

---

## ‚úÖ –ß–¢–û –ü–û–î–ì–û–¢–û–í–õ–ï–ù–û

–Ø —Å–æ–∑–¥–∞–ª **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã** –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL:

### üìÑ –§–∞–π–ª—ã:

```
‚úì scripts/init-postgresql.sql       - SQL –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã)
‚úì scripts/setup-postgresql.sh       - Bash —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–û–õ–ù–û–°–¢–¨–Æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DATABASE_URL
export DATABASE_URL="postgresql://user:password@host:5432/database"

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
./scripts/setup-postgresql.sh

# –ì–æ—Ç–æ–≤–æ! –°–∫—Ä–∏–ø—Ç —Å–¥–µ–ª–∞–µ—Ç –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
#   ‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
#   ‚úì –°–æ–∑–¥–∞—Å—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
#   ‚úì –°–æ–∑–¥–∞—Å—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (17 —à—Ç)
#   ‚úì –°–æ–∑–¥–∞—Å—Ç –∏–Ω–¥–µ–∫—Å—ã (9 —à—Ç)
#   ‚úì –î–æ–±–∞–≤–∏—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
#   ‚úì –ü—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –¢–æ–ª—å–∫–æ SQL (–µ—Å–ª–∏ –Ω–µ—Ç bash)

```bash
psql "$DATABASE_URL" -f scripts/init-postgresql.sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –° –ø–µ—Ä–µ–¥–∞—á–µ–π CONNECTION STRING –Ω–∞–ø—Ä—è–º—É—é

```bash
./scripts/setup-postgresql.sh "postgresql://user:password@host:5432/database"
```

---

## üìã –ì–î–ï –í–ó–Ø–¢–¨ DATABASE_URL?

### –ï—Å–ª–∏ —Å–æ–∑–¥–∞–ª–∏ PostgreSQL –≤ Timeweb:

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://timeweb.cloud/databases
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à—É –±–∞–∑—É: `kamchatour-db`
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Connection String**:
   ```
   postgresql://gen_user:abc123@pg12345.timeweb.cloud:5432/kamchatour
   ```

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Supabase (–±–µ—Å–ø–ª–∞—Ç–Ω–æ):

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://supabase.com/dashboard
2. Project Settings ‚Üí Database ‚Üí Connection String
3. –í—ã–±–µ—Ä–∏—Ç–µ: **URI** (–Ω–µ Pooler!)
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Neon (–±–µ—Å–ø–ª–∞—Ç–Ω–æ):

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://console.neon.tech/
2. Dashboard ‚Üí Connection Details
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Connection String

---

## üîß –ß–¢–û –î–ï–õ–ê–ï–¢ –°–ö–†–ò–ü–¢?

### 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```bash
‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL...
‚úì DATABASE_URL –Ω–∞–π–¥–µ–Ω–∞

‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL...
‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
```

### 2. –°–æ–∑–¥–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS postgis;
```

### 3. –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã (17 —à—Ç):

```
‚úì users                    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚úì transfer_operators       - –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
‚úì vehicles                 - –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
‚úì transfer_routes          - –ú–∞—Ä—à—Ä—É—Ç—ã
‚úì transfer_schedules       - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
‚úì transfer_bookings        - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚úì transfer_payments        - –ü–ª–∞—Ç–µ–∂–∏
‚úì transfer_notifications   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚úì seat_holds              - –£–¥–µ—Ä–∂–∞–Ω–∏–µ –º–µ—Å—Ç (–≤–∞–∂–Ω–æ!)
‚úì loyalty_tiers           - –£—Ä–æ–≤–Ω–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
‚úì user_loyalty            - –ë–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úì loyalty_transactions    - –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤
‚úì eco_points              - –≠–∫–æ-–±–∞–ª–ª—ã
‚úì eco_transactions        - –ò—Å—Ç–æ—Ä–∏—è —ç–∫–æ-–±–∞–ª–ª–æ–≤
+ 3 –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
```

### 4. –°–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```sql
‚úì 9 –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö
‚úì GIST –∏–Ω–¥–µ–∫—Å –¥–ª—è –≥–µ–æ–ø–æ–∏—Å–∫–∞
```

### 5. –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```sql
‚úì 4 —É—Ä–æ–≤–Ω—è –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏:
  - –ë—Ä–æ–Ω–∑–æ–≤—ã–π (0 –±–∞–ª–ª–æ–≤, 0% —Å–∫–∏–¥–∫–∞)
  - –°–µ—Ä–µ–±—Ä—è–Ω—ã–π (1000 –±–∞–ª–ª–æ–≤, 5% —Å–∫–∏–¥–∫–∞)
  - –ó–æ–ª–æ—Ç–æ–π (5000 –±–∞–ª–ª–æ–≤, 10% —Å–∫–∏–¥–∫–∞)
  - –ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π (10000 –±–∞–ª–ª–æ–≤, 15% —Å–∫–∏–¥–∫–∞)
```

### 6. –°–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏

```sql
cleanup_expired_seat_holds() - –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —É–¥–µ—Ä–∂–∞–Ω–∏–π
```

### 7. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

```bash
–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏? (y/N): y

‚úì –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: test@kamhub.ru
‚úì –¢–µ—Å—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä: –ö–∞–º—á–∞—Ç–∫–∞ –¢—Ä–∞–Ω—Å—Ñ–µ—Ä
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –ù–ê–°–¢–†–û–ô–ö–ò

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã:

```bash
psql "$DATABASE_URL" -c "\dt"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:** –°–ø–∏—Å–æ–∫ –∏–∑ 17 —Ç–∞–±–ª–∏—Ü

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ API:

```bash
curl https://kamchatour-125051.timeweb.cloud/api/health/db
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```json
{
  "success": true,
  "database": "connected",
  "tables": 17
}
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:

```bash
psql "$DATABASE_URL" -c "SELECT extname FROM pg_extension WHERE extname IN ('uuid-ossp', 'postgis');"
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
 extname
----------
 uuid-ossp
 postgis
```

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

‚úÖ **–ù–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞—à CONNECTION STRING  
‚úÖ **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö** - –∑–∞—â–∏—Ç–∞ –æ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤  
‚úÖ **UNIQUE constraints** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤  
‚úÖ **Foreign keys** - —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö  
‚úÖ **–§—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º—É—Å–æ—Ä–∞  

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

```env
# –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSL
DATABASE_SSL=true

# –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
DATABASE_MAX_CONNECTIONS=10

# –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ DATABASE_URL –≤ Git!
```

---

## üÜò TROUBLESHOOTING

### –û—à–∏–±–∫–∞: "DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
export DATABASE_URL="postgresql://user:password@host:5432/database"
```

### –û—à–∏–±–∫–∞: "connection refused"

**–ü—Ä–∏—á–∏–Ω—ã:**
- PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω
- Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ä—Ç 5432
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ö–æ—Å—Ç –≤ CONNECTION STRING

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å PostgreSQL –≤ Timeweb Dashboard
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CONNECTION STRING
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é: `psql "$DATABASE_URL"`

### –û—à–∏–±–∫–∞: "permission denied"

**–ü—Ä–∏—á–∏–Ω–∞:** –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

**–†–µ—à–µ–Ω–∏–µ:**
```sql
GRANT ALL PRIVILEGES ON DATABASE kamchatour TO your_user;
GRANT ALL PRIVILEGES ON SCHEMA public TO your_user;
```

### –û—à–∏–±–∫–∞: "extension ... does not exist"

**–ü—Ä–∏—á–∏–Ω–∞:** –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –û—Ç —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
CREATE EXTENSION "uuid-ossp";
CREATE EXTENSION postgis;
```

–ò–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Timeweb –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

**–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   ./scripts/setup-postgresql.sh 2>&1 | tee setup.log
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é PostgreSQL:
   ```bash
   psql "$DATABASE_URL" -c "SELECT version();"
   ```
   
   –¢—Ä–µ–±—É–µ—Ç—Å—è: **PostgreSQL 12+**

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ```bash
   psql "$DATABASE_URL" -c "\du"
   ```

---

## üéØ –ü–û–°–õ–ï –ù–ê–°–¢–†–û–ô–ö–ò

### 1. –î–æ–±–∞–≤—å—Ç–µ DATABASE_URL –≤ Timeweb Apps

```
https://timeweb.cloud/my/apps/125051
Settings ‚Üí Environment Variables:

DATABASE_URL=<–≤–∞—à connection string>
DATABASE_SSL=true
DATABASE_MAX_CONNECTIONS=10
```

### 2. Restart –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
Settings ‚Üí Restart Application
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ API

```bash
curl https://kamchatour-125051.timeweb.cloud/api/health/db
```

### 4. –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! ‚úÖ

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞:**

```
‚úì –†–∞—Å—à–∏—Ä–µ–Ω–∏—è: 2
‚úì –¢–∞–±–ª–∏—Ü—ã: 17
‚úì –ò–Ω–¥–µ–∫—Å—ã: 9
‚úì –§—É–Ω–∫—Ü–∏–∏: 1
‚úì –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏: 4 (loyalty tiers)
‚úì –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~30 —Å–µ–∫—É–Ω–¥
```

---

## üöÄ –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´

### –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:

```bash
export DATABASE_URL="your_connection_string" && ./scripts/setup-postgresql.sh
```

### –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É —Å –Ω—É–ª—è:

```bash
# ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!
psql "$DATABASE_URL" -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
./scripts/setup-postgresql.sh
```

### –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

```bash
# –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç IF NOT EXISTS, –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
psql "$DATABASE_URL" -f scripts/init-postgresql.sql
```

---

## ‚úÖ –ì–û–¢–û–í–û!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –≤–∞—à–∞ PostgreSQL –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `/api/health/db`

---

**–ê–≤—Ç–æ—Ä:** Cursor AI Agent  
**–î–∞—Ç–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** Ready to run ‚úÖ
