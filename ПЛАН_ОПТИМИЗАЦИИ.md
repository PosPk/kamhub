# ‚ö° –ü–õ–ê–ù –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò KAMCHATOUR HUB

> **–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏**  
> **–í–µ—Ä—Å–∏—è:** 1.0  
> **–î–∞—Ç–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2025

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è](#–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è)
2. [–§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è](#—Ñ–∞–∑–∞-1-–∫—Ä–∏—Ç–∏—á–Ω—ã–µ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è-1-2-–Ω–µ–¥–µ–ª–∏)
3. [–§–∞–∑–∞ 2: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#—Ñ–∞–∑–∞-2-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å-2-3-–Ω–µ–¥–µ–ª–∏)
4. [–§–∞–∑–∞ 3: –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å](#—Ñ–∞–∑–∞-3-–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å-1-–º–µ—Å—è—Ü)
5. [–§–∞–∑–∞ 4: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ ML](#—Ñ–∞–∑–∞-4-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞-–∏-ml-2-–º–µ—Å—è—Ü–∞)
6. [–ë—é–¥–∂–µ—Ç –∏ —Ä–µ—Å—É—Ä—Å—ã](#–±—é–¥–∂–µ—Ç-–∏-—Ä–µ—Å—É—Ä—Å—ã)
7. [–ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞](#–º–µ—Ç—Ä–∏–∫–∏-—É—Å–ø–µ—Ö–∞)

---

## üéØ –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø

### –ú–∞—Ç—Ä–∏—Ü–∞ RICE Score

| –ó–∞–¥–∞—á–∞ | Reach | Impact | Confidence | Effort | RICE | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------|--------|------------|--------|------|-----------|
| –ò—Å–ø—Ä–∞–≤–∏—Ç—å race conditions | 10 | 10 | 100% | 2 | 50.0 | üî¥ P0 |
| –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 10 | 9 | 90% | 5 | 16.2 | üî¥ P0 |
| –í–Ω–µ–¥—Ä–∏—Ç—å Redis –∫—ç—à | 10 | 8 | 100% | 3 | 26.7 | üü† P1 |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Sentry | 10 | 7 | 90% | 2 | 31.5 | üü† P1 |
| Database backup | 5 | 10 | 100% | 1 | 50.0 | üî¥ P0 |
| Real-time GPS | 8 | 7 | 70% | 8 | 4.9 | üü° P2 |
| ML –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | 6 | 6 | 60% | 10 | 2.16 | üü¢ P3 |
| –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | 9 | 8 | 80% | 12 | 4.8 | üü° P2 |

**–õ–µ–≥–µ–Ω–¥–∞:**
- Reach: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (1-10)
- Impact: –í–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å (1-10)
- Confidence: –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —É—Å–ø–µ—Ö–µ (%)
- Effort: –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã –≤ —á–µ–ª–æ–≤–µ–∫–æ-–Ω–µ–¥–µ–ª—è—Ö

---

## üö® –§–ê–ó–ê 1: –ö–†–ò–¢–ò–ß–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (1-2 –Ω–µ–¥–µ–ª–∏)

### –¶–µ–ª—å
–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏ —Ä–∏—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.

### –ó–∞–¥–∞—á–∏

#### 1.1 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Race Conditions üî¥ –ö–†–ò–¢–ò–ß–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ–∑–º–æ–∂–µ–Ω –æ–≤–µ—Ä–±—É–∫–∏–Ω–≥ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
BEGIN;

-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
SELECT available_seats 
FROM transfer_schedules 
WHERE id = $1 
FOR UPDATE NOWAIT;

-- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
UPDATE transfer_schedules 
SET available_seats = available_seats - $2 
WHERE id = $1 
  AND available_seats >= $2
RETURNING available_seats;

-- –ï—Å–ª–∏ affected rows = 0, –∑–Ω–∞—á–∏—Ç –º–µ—Å—Ç –Ω–µ—Ç
IF NOT FOUND THEN
  ROLLBACK;
  RAISE EXCEPTION 'No seats available';
END IF;

-- –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
INSERT INTO transfer_bookings (...) VALUES (...);

COMMIT;
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// /lib/transfers/booking.ts
export async function createBookingWithLock(
  scheduleId: string,
  passengers: number
): Promise<TransferBooking> {
  return await transaction(async (client) => {
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    const schedule = await client.query(
      `SELECT available_seats FROM transfer_schedules 
       WHERE id = $1 FOR UPDATE NOWAIT`,
      [scheduleId]
    );
    
    if (schedule.rows[0].available_seats < passengers) {
      throw new Error('Not enough seats');
    }
    
    // –£–º–µ–Ω—å—à–µ–Ω–∏–µ –º–µ—Å—Ç
    const result = await client.query(
      `UPDATE transfer_schedules 
       SET available_seats = available_seats - $1 
       WHERE id = $2 AND available_seats >= $1
       RETURNING *`,
      [passengers, scheduleId]
    );
    
    if (result.rowCount === 0) {
      throw new Error('Seats were taken by another user');
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const booking = await client.query(
      `INSERT INTO transfer_bookings 
       (schedule_id, passengers_count, status, ...) 
       VALUES ($1, $2, 'pending', ...)
       RETURNING *`,
      [scheduleId, passengers, ...]
    );
    
    return booking.rows[0];
  });
}
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
// test/booking-race-condition.test.ts
describe('Race Condition Prevention', () => {
  it('should prevent overbooking with concurrent requests', async () => {
    const scheduleId = 'test-schedule-1';
    const availableSeats = 1;
    
    // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å 1 –º–µ—Å—Ç–æ–º
    await createSchedule({ id: scheduleId, available_seats: 1 });
    
    // 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ 1 –º–µ—Å—Ç–æ
    const results = await Promise.allSettled([
      createBooking(scheduleId, 1),
      createBooking(scheduleId, 1)
    ]);
    
    // –û–∂–∏–¥–∞–µ–º: 1 —É—Å–ø–µ—Ö, 1 –æ—à–∏–±–∫–∞
    const successful = results.filter(r => r.status === 'fulfilled');
    const failed = results.filter(r => r.status === 'rejected');
    
    expect(successful.length).toBe(1);
    expect(failed.length).toBe(1);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å 0 –º–µ—Å—Ç
    const schedule = await getSchedule(scheduleId);
    expect(schedule.available_seats).toBe(0);
  });
});
```

**–í—Ä–µ–º—è:** 3 –¥–Ω—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ P0  
**–†–∏—Å–∫:** HIGH

---

#### 1.2 –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ Backup –ë–î üî¥ –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç backup —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**

**Vercel Postgres (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):**
```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –≤–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
# Retention: 7 –¥–Ω–µ–π –¥–ª—è Hobby, 14 –¥–Ω–µ–π –¥–ª—è Pro
```

**–ö–∞—Å—Ç–æ–º–Ω—ã–π PostgreSQL:**
```bash
#!/bin/bash
# /scripts/backup-db.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"
DB_NAME="kamchatour"
DB_HOST="localhost"
DB_USER="postgres"

# Full backup
pg_dump -h $DB_HOST -U $DB_USER -F c -b -v -f \
  "$BACKUP_DIR/kamchatour_$DATE.backup" $DB_NAME

# Compress
gzip "$BACKUP_DIR/kamchatour_$DATE.backup"

# Upload to S3
aws s3 cp "$BACKUP_DIR/kamchatour_$DATE.backup.gz" \
  s3://kamchatour-backups/db/

# Delete local backups older than 7 days
find $BACKUP_DIR -name "*.backup.gz" -mtime +7 -delete

# Delete S3 backups older than 30 days
aws s3 ls s3://kamchatour-backups/db/ | \
  awk '$1 < "'$(date -d '30 days ago' +%Y-%m-%d)'" {print $4}' | \
  xargs -I {} aws s3 rm s3://kamchatour-backups/db/{}
```

**Cron job:**
```cron
# –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
0 */6 * * * /scripts/backup-db.sh >> /var/log/backup.log 2>&1
```

**Point-in-time recovery:**
```sql
-- –í–∫–ª—é—á–∏—Ç—å WAL –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
ALTER SYSTEM SET wal_level = replica;
ALTER SYSTEM SET archive_mode = on;
ALTER SYSTEM SET archive_command = 'cp %p /archive/%f';

-- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PostgreSQL
SELECT pg_reload_conf();
```

**Restore –ø—Ä–æ—Ü–µ–¥—É—Ä–∞:**
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup
pg_restore -h localhost -U postgres -d kamchatour_new \
  -v kamchatour_20251030_120000.backup

# Point-in-time restore
pg_restore -h localhost -U postgres -d kamchatour_new \
  --target-time='2025-10-30 12:30:00' \
  kamchatour_20251030_120000.backup
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ backup:**
```typescript
// /scripts/check-backups.ts
import { S3 } from 'aws-sdk';

async function checkBackups() {
  const s3 = new S3();
  const backups = await s3.listObjectsV2({
    Bucket: 'kamchatour-backups',
    Prefix: 'db/'
  }).promise();
  
  const latestBackup = backups.Contents?.sort((a, b) => 
    b.LastModified!.getTime() - a.LastModified!.getTime()
  )[0];
  
  const hoursSinceLastBackup = 
    (Date.now() - latestBackup!.LastModified!.getTime()) / 1000 / 60 / 60;
  
  if (hoursSinceLastBackup > 7) {
    await sendAlert('CRITICAL: No backup in last 7 hours!');
  }
  
  console.log(`‚úÖ Latest backup: ${latestBackup!.Key}`);
  console.log(`‚è∞ Age: ${hoursSinceLastBackup.toFixed(1)} hours`);
}

// –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å
setInterval(checkBackups, 60 * 60 * 1000);
```

**–í—Ä–µ–º—è:** 2 –¥–Ω—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ P0  
**–†–∏—Å–∫:** CATASTROPHIC

---

#### 1.3 –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ üî¥ –ö–†–ò–¢–ò–ß–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:** 0% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤:**
```
/test
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ matching-algorithm.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ pricing-calculator.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ loyalty-system.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ notifications.test.ts
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ booking-flow.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ payment-flow.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ api-endpoints.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ database-operations.test.ts
‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îú‚îÄ‚îÄ user-journey.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ operator-dashboard.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ payment-integration.test.ts
‚îî‚îÄ‚îÄ load/
    ‚îú‚îÄ‚îÄ concurrent-bookings.test.ts
    ‚îî‚îÄ‚îÄ api-stress.test.ts
```

**–ü—Ä–∏–º–µ—Ä unit —Ç–µ—Å—Ç–∞:**
```typescript
// test/unit/matching-algorithm.test.ts
import { matchDriver } from '@/lib/transfers/matching';

describe('Driver Matching Algorithm', () => {
  it('should select driver with highest score', () => {
    const drivers = [
      { id: '1', rating: 4.5, distance: 10, total_trips: 100 },
      { id: '2', rating: 5.0, distance: 5, total_trips: 200 },
      { id: '3', rating: 4.0, distance: 3, total_trips: 50 }
    ];
    
    const best = matchDriver(drivers, booking);
    expect(best.id).toBe('2'); // –õ—É—á—à–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∏ –±–ª–∏–∑–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
  });
  
  it('should handle no available drivers', () => {
    const result = matchDriver([], booking);
    expect(result).toBeNull();
  });
  
  it('should respect language preferences', () => {
    const drivers = [
      { id: '1', rating: 5.0, languages: ['ru'] },
      { id: '2', rating: 4.8, languages: ['ru', 'en', 'zh'] }
    ];
    
    const booking = { preferredLanguages: ['zh'] };
    const best = matchDriver(drivers, booking);
    expect(best.id).toBe('2');
  });
});
```

**–ü—Ä–∏–º–µ—Ä integration —Ç–µ—Å—Ç–∞:**
```typescript
// test/integration/booking-flow.test.ts
describe('Booking Flow Integration', () => {
  beforeEach(async () => {
    await clearDatabase();
    await seedTestData();
  });
  
  it('should complete full booking flow', async () => {
    // 1. –ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤
    const search = await fetch('/api/transfers/search', {
      method: 'POST',
      body: JSON.stringify({
        from: 'Airport',
        to: 'City Center',
        date: '2025-11-01',
        passengers: 2
      })
    });
    const { data: schedules } = await search.json();
    expect(schedules).toHaveLength(5);
    
    // 2. –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const book = await fetch('/api/transfers/book', {
      method: 'POST',
      body: JSON.stringify({
        scheduleId: schedules[0].id,
        passengers: 2,
        contactPhone: '+79141234567',
        contactEmail: 'test@example.com'
      })
    });
    const { data: booking } = await book.json();
    expect(booking.status).toBe('pending');
    expect(booking.confirmationCode).toMatch(/^[A-Z0-9]{10}$/);
    
    // 3. –≠–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã
    const payment = await fetch('/api/transfers/payment/confirm', {
      method: 'POST',
      body: JSON.stringify({
        TransactionId: 12345,
        Amount: booking.totalPrice,
        InvoiceId: booking.id,
        Status: 'Completed'
      })
    });
    expect(payment.status).toBe(200);
    
    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const confirmed = await getBooking(booking.id);
    expect(confirmed.status).toBe('confirmed');
    
    // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è –º–µ—Å—Ç
    const schedule = await getSchedule(schedules[0].id);
    expect(schedule.available_seats).toBe(
      schedules[0].available_seats - 2
    );
    
    // 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const notifications = await getNotifications(booking.userId);
    expect(notifications).toHaveLength(2); // –°–æ–∑–¥–∞–Ω–∏–µ + –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  });
});
```

**–ü—Ä–∏–º–µ—Ä E2E —Ç–µ—Å—Ç–∞:**
```typescript
// test/e2e/user-journey.test.ts
import { test, expect } from '@playwright/test';

test('User can book a transfer', async ({ page }) => {
  // 1. –û—Ç–∫—Ä—ã—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  await page.goto('/');
  
  // 2. –ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞
  await page.fill('input[name="from"]', 'Airport');
  await page.fill('input[name="to"]', 'City Center');
  await page.fill('input[name="date"]', '2025-11-01');
  await page.fill('input[name="passengers"]', '2');
  await page.click('button:has-text("–ù–∞–π—Ç–∏")');
  
  // 3. –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  await page.waitForSelector('.transfer-card');
  const cards = await page.$$('.transfer-card');
  expect(cards.length).toBeGreaterThan(0);
  
  // 4. –í—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  await cards[0].click();
  
  // 5. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  await page.fill('input[name="phone"]', '+79141234567');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.click('button:has-text("–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å")');
  
  // 6. –≠–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
  await page.waitForURL('**/payment/**');
  await page.fill('input[name="card"]', '4111111111111111');
  await page.fill('input[name="expiry"]', '12/25');
  await page.fill('input[name="cvv"]', '123');
  await page.click('button:has-text("–û–ø–ª–∞—Ç–∏—Ç—å")');
  
  // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  await page.waitForURL('**/booking/success/**');
  await expect(page.locator('.confirmation-code')).toBeVisible();
});
```

**Coverage —Ü–µ–ª–∏:**
```
Unit Tests:        80%+ ‚úÖ
Integration:       70%+ ‚úÖ
E2E:               50%+ ‚úÖ
Critical Paths:   100%+ ‚úÖ
```

**CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npm run type-check
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Run integration tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

**–í—Ä–µ–º—è:** 1 –Ω–µ–¥–µ–ª—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ P0  
**–†–∏—Å–∫:** HIGH

---

#### 1.4 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ Alerting üü† P1

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è, –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫

**–†–µ—à–µ–Ω–∏–µ:**

**Sentry –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫:**
```typescript
// lib/monitoring/sentry.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0, // 100% —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  beforeSend(event, hint) {
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (event.request?.headers) {
      delete event.request.headers['authorization'];
      delete event.request.headers['cookie'];
    }
    return event;
  }
});

// –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è API routes
export function withSentry(handler: Function) {
  return async (req: NextRequest) => {
    try {
      return await handler(req);
    } catch (error) {
      Sentry.captureException(error, {
        tags: {
          route: req.url,
          method: req.method
        },
        extra: {
          body: await req.json().catch(() => null),
          headers: Object.fromEntries(req.headers)
        }
      });
      throw error;
    }
  };
}
```

**Custom metrics:**
```typescript
// lib/monitoring/metrics.ts
import * as Sentry from '@sentry/nextjs';

export class Metrics {
  static trackBooking(booking: TransferBooking) {
    Sentry.addBreadcrumb({
      category: 'booking',
      message: 'Booking created',
      level: 'info',
      data: {
        bookingId: booking.id,
        scheduleId: booking.scheduleId,
        passengers: booking.passengersCount,
        price: booking.totalPrice
      }
    });
  }
  
  static trackPayment(payment: Payment) {
    Sentry.metrics.increment('payment.success', 1, {
      tags: {
        method: payment.method,
        amount: payment.amount.toString()
      }
    });
  }
  
  static trackSearchPerformance(duration: number) {
    Sentry.metrics.distribution('search.duration', duration, {
      unit: 'millisecond'
    });
  }
}
```

**Alerting –ø—Ä–∞–≤–∏–ª–∞:**
```typescript
// Sentry Alerts Configuration
[
  {
    name: 'High Error Rate',
    condition: 'error_count > 10 in 5 minutes',
    action: 'Send to Telegram + Email'
  },
  {
    name: 'Payment Failures',
    condition: 'payment.failed > 5 in 10 minutes',
    action: 'Send to Telegram immediately'
  },
  {
    name: 'Database Connection Issues',
    condition: 'database.connection_error > 0',
    action: 'Send to Telegram + SMS'
  },
  {
    name: 'Slow API Response',
    condition: 'api.response_time > 3000ms for 50% requests',
    action: 'Send to Telegram'
  }
]
```

**Dashboard –º–µ—Ç—Ä–∏–∫:**
```typescript
// app/admin/metrics/page.tsx
export default function MetricsDashboard() {
  const metrics = useMetrics();
  
  return (
    <div className="grid grid-cols-4 gap-4">
      <MetricCard
        title="Bookings Today"
        value={metrics.bookingsToday}
        change="+12%"
        icon="üìä"
      />
      <MetricCard
        title="Revenue Today"
        value={`‚ÇΩ${metrics.revenueToday}`}
        change="+8%"
        icon="üí∞"
      />
      <MetricCard
        title="Error Rate"
        value={`${metrics.errorRate}%`}
        change="-2%"
        status={metrics.errorRate < 1 ? 'good' : 'bad'}
        icon="üêõ"
      />
      <MetricCard
        title="Avg Response Time"
        value={`${metrics.avgResponseTime}ms`}
        change="-15%"
        icon="‚ö°"
      />
      
      <div className="col-span-4">
        <Chart data={metrics.hourlyBookings} />
      </div>
    </div>
  );
}
```

**–í—Ä–µ–º—è:** 3 –¥–Ω—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† P1  
**–†–∏—Å–∫:** MEDIUM

---

### –ò—Ç–æ–≥–∏ –§–∞–∑—ã 1

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 2 –Ω–µ–¥–µ–ª–∏  
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0 (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ 70%+ coverage —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## ‚ö° –§–ê–ó–ê 2: –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ (2-3 –Ω–µ–¥–µ–ª–∏)

### –¶–µ–ª—å
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ —Ä–æ—Å—Ç—É –Ω–∞–≥—Ä—É–∑–∫–∏.

### –ó–∞–¥–∞—á–∏

#### 2.1 Redis –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ üü† P1

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –∑–∞–º–µ–¥–ª—è—é—Ç —Å–∏—Å—Ç–µ–º—É

**–†–µ—à–µ–Ω–∏–µ:**

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis:**
```bash
# Docker compose
version: '3.8'
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
```

**Redis client:**
```typescript
// lib/cache/redis.ts
import Redis from 'ioredis';

const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT || '6379'),
  password: process.env.REDIS_PASSWORD,
  retryStrategy: (times) => {
    return Math.min(times * 50, 2000);
  }
});

export class CacheService {
  static async get<T>(key: string): Promise<T | null> {
    const value = await redis.get(key);
    return value ? JSON.parse(value) : null;
  }
  
  static async set(
    key: string, 
    value: any, 
    ttl: number = 3600
  ): Promise<void> {
    await redis.setex(key, ttl, JSON.stringify(value));
  }
  
  static async delete(key: string): Promise<void> {
    await redis.del(key);
  }
  
  static async invalidatePattern(pattern: string): Promise<void> {
    const keys = await redis.keys(pattern);
    if (keys.length > 0) {
      await redis.del(...keys);
    }
  }
}
```

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞:**
```typescript
// app/api/transfers/search/route.ts
export async function POST(req: NextRequest) {
  const { from, to, date, passengers, vehicleType } = await req.json();
  
  // –ö–ª—é—á –∫—ç—à–∞
  const cacheKey = `search:${from}:${to}:${date}:${passengers}:${vehicleType}`;
  
  // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞
  const cached = await CacheService.get(cacheKey);
  if (cached) {
    return NextResponse.json({
      success: true,
      data: cached,
      cached: true
    });
  }
  
  // –ó–∞–ø—Ä–æ—Å –∫ –ë–î
  const results = await searchTransfers({from, to, date, passengers, vehicleType});
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç
  await CacheService.set(cacheKey, results, 300);
  
  return NextResponse.json({
    success: true,
    data: results,
    cached: false
  });
}
```

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞:**
```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
await CacheService.invalidatePattern('search:*');

// –ü–æ—Å–ª–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
await CacheService.invalidatePattern(`search:*:${route.from}:${route.to}:*`);
```

**–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:**
```typescript
// app/api/operator/stats/route.ts
export async function GET(req: NextRequest) {
  const operatorId = req.nextUrl.searchParams.get('operatorId');
  const cacheKey = `stats:operator:${operatorId}`;
  
  const cached = await CacheService.get(cacheKey);
  if (cached) return NextResponse.json(cached);
  
  const stats = await getOperatorStats(operatorId);
  
  // –ö—ç—à –Ω–∞ 1 —á–∞—Å
  await CacheService.set(cacheKey, stats, 3600);
  
  return NextResponse.json(stats);
}
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞:**
```typescript
// lib/cache/monitoring.ts
setInterval(async () => {
  const info = await redis.info('stats');
  const hitRate = calculateHitRate(info);
  
  console.log(`Cache hit rate: ${hitRate}%`);
  
  if (hitRate < 50) {
    await sendAlert('Low cache hit rate!');
  }
}, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞: —Å 500ms –¥–æ 50ms (10x)
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: -70%
- Cache hit rate: 60-80%

**–í—Ä–µ–º—è:** 4 –¥–Ω—è  
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $10-20/–º–µ—Å—è—Ü (Upstash Redis)  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† P1

---

#### 2.2 Database Optimization üü° P2

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä–µ–º–µ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**

**1. –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
```sql
-- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
ALTER SYSTEM SET log_min_duration_statement = 100; -- 100ms
ALTER SYSTEM SET log_statement = 'all';

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
SELECT 
  query,
  calls,
  total_time,
  mean_time,
  max_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 20;
```

**2. –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**
```sql
-- –î–ª—è —á–∞—Å—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: –ø–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ –∏ —Å—Ç–∞—Ç—É—Å—É
CREATE INDEX idx_bookings_date_status 
ON transfer_bookings (booking_date, status)
INCLUDE (user_id, total_price);

-- –î–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
CREATE INDEX idx_schedules_route_date_seats 
ON transfer_schedules (route_id, departure_time)
WHERE available_seats > 0 AND is_active = true;

-- Partial index –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
CREATE INDEX idx_schedules_active 
ON transfer_schedules (departure_time, available_seats)
WHERE is_active = true;
```

**3. –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:**
```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ —á–∞—Å)
CREATE MATERIALIZED VIEW mv_operator_stats AS
SELECT 
  o.id,
  o.name,
  COUNT(DISTINCT b.id) as total_bookings,
  SUM(b.total_price) as total_revenue,
  AVG(d.rating) as avg_rating,
  COUNT(DISTINCT CASE WHEN b.booking_date = CURRENT_DATE THEN b.id END) as bookings_today
FROM operators o
LEFT JOIN transfer_bookings b ON o.id = b.operator_id
LEFT JOIN transfer_drivers d ON o.id = d.operator_id
GROUP BY o.id, o.name;

-- –ò–Ω–¥–µ–∫—Å –Ω–∞ materialized view
CREATE UNIQUE INDEX idx_mv_operator_stats_id 
ON mv_operator_stats (id);

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π —á–∞—Å
CREATE OR REPLACE FUNCTION refresh_operator_stats()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY mv_operator_stats;
END;
$$ LANGUAGE plpgsql;

-- Cron job –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
SELECT cron.schedule('refresh-operator-stats', '0 * * * *', 
  'SELECT refresh_operator_stats()');
```

**4. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü:**
```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ transfer_bookings –ø–æ –¥–∞—Ç–µ
CREATE TABLE transfer_bookings_partitioned (
  LIKE transfer_bookings INCLUDING ALL
) PARTITION BY RANGE (booking_date);

-- –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
CREATE TABLE transfer_bookings_2025_10 PARTITION OF transfer_bookings_partitioned
  FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');
  
CREATE TABLE transfer_bookings_2025_11 PARTITION OF transfer_bookings_partitioned
  FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
  
-- ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
  start_date date;
  end_date date;
  table_name text;
BEGIN
  start_date := date_trunc('month', CURRENT_DATE + interval '1 month');
  end_date := start_date + interval '1 month';
  table_name := 'transfer_bookings_' || to_char(start_date, 'YYYY_MM');
  
  EXECUTE format(
    'CREATE TABLE IF NOT EXISTS %I PARTITION OF transfer_bookings_partitioned
     FOR VALUES FROM (%L) TO (%L)',
    table_name, start_date, end_date
  );
END;
$$ LANGUAGE plpgsql;
```

**5. Connection Pooling:**
```typescript
// lib/database.ts
const pool = new Pool({
  connectionString: config.database.url,
  max: 20,              // –ú–∞–∫—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
  statement_timeout: 10000, // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å –Ω–∞ –∑–∞–ø—Ä–æ—Å
});

// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É–ª–∞
pool.on('connect', () => {
  console.log('New client connected');
});

pool.on('error', (err) => {
  console.error('Pool error:', err);
  Sentry.captureException(err);
});
```

**6. Query –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
```typescript
// –ü–õ–û–•–û: N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
const bookings = await getBookings();
for (const booking of bookings) {
  booking.driver = await getDriver(booking.driverId);
  booking.vehicle = await getVehicle(booking.vehicleId);
}

// –•–û–†–û–®–û: 1 –∑–∞–ø—Ä–æ—Å —Å JOIN
const bookings = await query(`
  SELECT 
    b.*,
    json_build_object(
      'id', d.id,
      'name', d.name,
      'rating', d.rating
    ) as driver,
    json_build_object(
      'id', v.id,
      'make', v.make,
      'model', v.model
    ) as vehicle
  FROM transfer_bookings b
  LEFT JOIN transfer_drivers d ON b.driver_id = d.id
  LEFT JOIN transfer_vehicles v ON b.vehicle_id = v.id
  WHERE b.user_id = $1
`, [userId]);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤: -50%
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU: -30%
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1000+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–í—Ä–µ–º—è:** 1 –Ω–µ–¥–µ–ª—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° P2

---

#### 2.3 Frontend Optimization üü° P2

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ–ª—å—à–æ–π bundle size, –º–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**

**1. Code Splitting:**
```typescript
// Lazy load heavy components
const AIChatWidget = dynamic(() => import('@/components/AIChatWidget'), {
  loading: () => <div>Loading AI Chat...</div>,
  ssr: false
});

const TransferMap = dynamic(() => import('@/components/TransferMap'), {
  loading: () => <div>Loading Map...</div>,
  ssr: false
});
```

**2. Image Optimization:**
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Next/Image –≤–µ–∑–¥–µ
import Image from 'next/image';

<Image
  src="/hero.jpg"
  alt="Kamchatka"
  width={1920}
  height={1080}
  priority
  placeholder="blur"
/>
```

**3. Bundle Analysis:**
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ package.json
"analyze": "ANALYZE=true next build"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
npm run analyze
```

**4. Tree Shaking:**
```typescript
// –ü–õ–û–•–û: –ò–º–ø–æ—Ä—Ç –≤—Å–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import _ from 'lodash';

// –•–û–†–û–®–û: –ò–º–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
import { debounce, throttle } from 'lodash';
```

**5. Prefetching:**
```typescript
// –ü—Ä–µ—Ñ–µ—Ç—á —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
<Link href="/tours" prefetch>
  –¢—É—Ä—ã
</Link>
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Bundle size: -40%
- First Contentful Paint: < 1.5s
- Time to Interactive: < 3s
- Lighthouse Score: 90+

**–í—Ä–µ–º—è:** 4 –¥–Ω—è  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° P2

---

### –ò—Ç–æ–≥–∏ –§–∞–∑—ã 2

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 3 –Ω–µ–¥–µ–ª–∏  
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $30-50/–º–µ—Å—è—Ü  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö° –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏: +300%
- üíæ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: -70%
- üöÄ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìà –§–ê–ó–ê 3: –ú–ê–°–®–¢–ê–ë–ò–†–£–ï–ú–û–°–¢–¨ (1 –º–µ—Å—è—Ü)

### –¶–µ–ª—å
–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∫ –±—ã—Å—Ç—Ä–æ–º—É —Ä–æ—Å—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–∞–Ω–Ω—ã—Ö.

### –ó–∞–¥–∞—á–∏

#### 3.1 Real-time Features üü° P2

**WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è live updates:**
```typescript
// lib/websocket/server.ts
import { Server } from 'socket.io';

export function initWebSocket(httpServer: any) {
  const io = new Server(httpServer, {
    cors: { origin: '*' }
  });
  
  io.on('connection', (socket) => {
    console.log('Client connected:', socket.id);
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    socket.on('subscribe:booking', (bookingId) => {
      socket.join(`booking:${bookingId}`);
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤–æ–¥–∏—Ç–µ–ª—è
    socket.on('driver:location', async (data) => {
      const { bookingId, lat, lng } = data;
      io.to(`booking:${bookingId}`).emit('driver:updated', {
        lat, lng, timestamp: Date.now()
      });
      
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis
      await redis.setex(
        `driver:location:${data.driverId}`,
        60,
        JSON.stringify({ lat, lng })
      );
    });
  });
  
  return io;
}
```

**Client integration:**
```typescript
// hooks/useRealtimeBooking.ts
import { useEffect, useState } from 'react';
import { io } from 'socket.io-client';

export function useRealtimeBooking(bookingId: string) {
  const [driverLocation, setDriverLocation] = useState(null);
  const [status, setStatus] = useState('pending');
  
  useEffect(() => {
    const socket = io(process.env.NEXT_PUBLIC_WS_URL);
    
    socket.emit('subscribe:booking', bookingId);
    
    socket.on('driver:updated', (data) => {
      setDriverLocation(data);
    });
    
    socket.on('booking:status', (data) => {
      setStatus(data.status);
    });
    
    return () => socket.disconnect();
  }, [bookingId]);
  
  return { driverLocation, status };
}
```

**–í—Ä–µ–º—è:** 1 –Ω–µ–¥–µ–ª—è  
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $20/–º–µ—Å—è—Ü (WebSocket server)

---

#### 3.2 –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ üü¢ P3

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         API Gateway (Next.js)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         ‚îÇ         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇTransfer‚îÇ ‚îÇPayment‚îÇ ‚îÇLoyalty‚îÇ
‚îÇService ‚îÇ ‚îÇService‚îÇ ‚îÇService‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ò–∑–æ–ª—è—Ü–∏—è —Å–±–æ–µ–≤
- –ì–∏–±–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

**–í—Ä–µ–º—è:** 2 –Ω–µ–¥–µ–ª–∏  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** HIGH

---

### –ò—Ç–æ–≥–∏ –§–∞–∑—ã 3

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 1 –º–µ—Å—è—Ü  
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $100-200/–º–µ—Å—è—Ü  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- üîÑ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- üì± –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- üèóÔ∏è –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## ü§ñ –§–ê–ó–ê 4: –ê–ù–ê–õ–ò–¢–ò–ö–ê –ò ML (2 –º–µ—Å—è—Ü–∞)

### 4.1 ML –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Å–ø—Ä–æ—Å–∞
### 4.2 –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
### 4.3 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
### 4.4 –ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

_(–î–µ—Ç–∞–ª–∏ –æ–ø—É—â–µ–Ω—ã –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)_

---

## üí∞ –ë–Æ–î–ñ–ï–¢ –ò –†–ï–°–£–†–°–´

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

| –°–µ—Ä–≤–∏—Å | –°—Ç–æ–∏–º–æ—Å—Ç—å/–º–µ—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|---------------|------------|
| Vercel Pro | $20 | –•–æ—Å—Ç–∏–Ω–≥ |
| PostgreSQL | $20 | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö |
| Redis (Upstash) | $10 | –ö—ç—à |
| Sentry | $26 | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| AWS S3 | $5 | Backups |
| **–ò–¢–û–ì–û** | **$81/–º–µ—Å** | |

### –ö–æ–º–∞–Ω–¥–∞

| –†–æ–ª—å | –ó–∞–≥—Ä—É–∑–∫–∞ | –í—Ä–µ–º—è |
|------|----------|-------|
| Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ | 100% | 3 –º–µ—Å—è—Ü–∞ |
| Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ | 50% | 2 –º–µ—Å—è—Ü–∞ |
| DevOps –∏–Ω–∂–µ–Ω–µ—Ä | 25% | 1 –º–µ—Å—è—Ü |
| QA –∏–Ω–∂–µ–Ω–µ—Ä | 50% | 2 –º–µ—Å—è—Ü–∞ |

---

## üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (Baseline)
```
API Response Time:     500-1000ms
Database Load:         70% CPU
Cache Hit Rate:        0%
Error Rate:            5-10%
Test Coverage:         0%
Lighthouse Score:      45/100
```

### –ü–æ—Å–ª–µ –§–∞–∑—ã 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)
```
API Response Time:     500-800ms
Database Load:         70% CPU
Cache Hit Rate:        0%
Error Rate:            <1% ‚úÖ
Test Coverage:         70%+ ‚úÖ
Lighthouse Score:      50/100
```

### –ü–æ—Å–ª–µ –§–∞–∑—ã 2 (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
```
API Response Time:     100-200ms ‚úÖ
Database Load:         40% CPU ‚úÖ
Cache Hit Rate:        60-80% ‚úÖ
Error Rate:            <0.5%
Test Coverage:         80%+
Lighthouse Score:      85/100 ‚úÖ
```

### –ü–æ—Å–ª–µ –§–∞–∑—ã 3 (–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å)
```
API Response Time:     50-150ms
Database Load:         30% CPU
Cache Hit Rate:        80%+
Error Rate:            <0.1%
Test Coverage:         90%+
Lighthouse Score:      95/100
Concurrent Users:      10,000+
```

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:** $243/–º–µ—Å (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)  
**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 4 –º–µ—Å—è—Ü–∞  
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –¥–æ 10,000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –§–∞–∑–∞ 2 —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏, –§–∞–∑—ã 3-4 –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞.

---

**–°–æ—Å—Ç–∞–≤–ª–µ–Ω–æ:** 30 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é
