# ‚úÖ –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ù–û–ô –†–ê–ë–û–¢–ï

**–î–∞—Ç–∞:** –î–µ–∫–∞–±—Ä—å 2024  
**–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** –ü–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –§–∞–∑—ã 1

---

## üéØ –ß–¢–û –£–ñ–ï –°–î–ï–õ–ê–ù–û

### ‚úÖ 1. –°–æ–∑–¥–∞–Ω Logger (`lib/logger.ts`)
**–ì–æ—Ç–æ–≤–æ:** –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–§—É–Ω–∫—Ü–∏–∏:**
- `logger.debug()` - —Ç–æ–ª—å–∫–æ –≤ development
- `logger.info()` - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `logger.warn()` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `logger.error()` - –æ—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- `logger.request()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤
- `logger.query()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ timestamps
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Sentry
- –¢–∏–ø–∏–∑–∞—Ü–∏—è TypeScript

---

### ‚úÖ 2. –°–æ–∑–¥–∞–Ω CSRF Client (`lib/utils/csrf-client.ts`)
**–ì–æ—Ç–æ–≤–æ:** –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CSRF –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–§—É–Ω–∫—Ü–∏–∏:**
- `getCsrfToken()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookie
- `ensureCsrfToken()` - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- `fetchWithCsrf()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// –í–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ fetch
await fetchWithCsrf('/api/transfers/book', {
  method: 'POST',
  body: JSON.stringify(data),
});
```

---

### ‚úÖ 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–Ω—ã–µ API routes

#### `/api/transfers/book` - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ `console.log/error` –Ω–∞ `logger`
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ CSRF –∑–∞—â–∏—Ç–∞ (`withCsrfProtection`)
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

#### `/api/transfers/search` - –ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ `console.error` –Ω–∞ `logger.error`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ª–æ–≥–∏

#### `/api/auth/signin` - –í—Ö–æ–¥
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω `console.error` –Ω–∞ `logger.error`
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ CSRF –∑–∞—â–∏—Ç–∞

#### `/api/auth/signup` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω `console.error` –Ω–∞ `logger.error`
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ CSRF –∑–∞—â–∏—Ç–∞

#### `/api/webhooks/cloudpayments` - Webhook –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ 7 `console.log/error` –Ω–∞ `logger`
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

### ‚úÖ 4. –û–±–Ω–æ–≤–ª–µ–Ω—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

#### `lib/transfers/booking.ts`
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ 5 `console.error` –Ω–∞ `logger.error`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∫–∞–∂–¥—ã–π –ª–æ–≥

#### `lib/payments/transfer-payments.ts`
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ 9 `console.log/error` –Ω–∞ `logger`
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: **7**
1. `lib/logger.ts` - —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π
2. `lib/utils/csrf-client.ts` - —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π
3. `app/api/transfers/book/route.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω
4. `app/api/transfers/search/route.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω
5. `app/api/auth/signin/route.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω
6. `app/api/auth/signup/route.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω
7. `app/api/webhooks/cloudpayments/route.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω
8. `lib/transfers/booking.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω
9. `lib/payments/transfer-payments.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω

### –ó–∞–º–µ–Ω–µ–Ω–æ console.log/error: **25+**
- `app/api/transfers/book/route.ts` - 4 –∑–∞–º–µ–Ω—ã
- `app/api/transfers/search/route.ts` - 2 –∑–∞–º–µ–Ω—ã
- `app/api/auth/*` - 2 –∑–∞–º–µ–Ω—ã
- `app/api/webhooks/cloudpayments/route.ts` - 7 –∑–∞–º–µ–Ω
- `lib/transfers/booking.ts` - 5 –∑–∞–º–µ–Ω
- `lib/payments/transfer-payments.ts` - 9 –∑–∞–º–µ–Ω

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ CSRF –∑–∞—â–∏—Ç–∞: **3 routes**
- `/api/transfers/book` - –∫—Ä–∏—Ç–∏—á–Ω–æ ‚úÖ
- `/api/auth/signin` - –∫—Ä–∏—Ç–∏—á–Ω–æ ‚úÖ
- `/api/auth/signup` - –∫—Ä–∏—Ç–∏—á–Ω–æ ‚úÖ

---

## üöÄ –ß–¢–û –î–ê–õ–¨–®–ï

### –°–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ (–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å):

1. **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ CSRF** (30 –º–∏–Ω)
   - `/api/tours` (POST, PUT, DELETE)
   - `/api/partners` (POST, PUT, DELETE)
   - `/api/loyalty/promo/apply`
   - `/api/transfers/confirm`
   - `/api/transfers/payment/confirm`

2. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å Rate Limiting** (1 —á–∞—Å)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–µ—Å–µ—Ç—ã
   - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º endpoints

3. **–°–æ–∑–¥–∞—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é** (2-3 —á–∞—Å–∞)
   - `lib/auth/jwt.ts`
   - `lib/auth/middleware.ts`
   - –û–±–Ω–æ–≤–∏—Ç—å routes

---

## üí° –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –£–ª—É—á—à–µ–Ω–∏—è:
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** CSRF –∑–∞—â–∏—Ç–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö routes
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤–º–µ—Å—Ç–æ console.log
- ‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** –ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Sentry

### –ö–æ–¥:
- ‚úÖ –ß–∏—Å—Ç—ã–π –∫–æ–¥ –±–µ–∑ console.log –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è TypeScript –≤–µ–∑–¥–µ
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìù –ü–†–ò–ú–ï–†–´ –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –î–æ:
```typescript
console.error('Database error:', dbError);
console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:', { bookingId });
```

### –ü–æ—Å–ª–µ:
```typescript
logger.error('Database error in transfer booking', dbError, {
  scheduleId: body.scheduleId,
  passengersCount: body.passengersCount,
});

logger.info('Booking notifications sent successfully', {
  bookingId: booking.id,
  smsSent: !!contactInfo.phone,
  emailSent: !!contactInfo.email,
});
```

---

## ‚úÖ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ü–†–û–î–ê–ö–®–ï–ù–£

**–î–æ —Ä–∞–±–æ—Ç—ã:** 95%  
**–ü–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã:** 96% (+1% –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)

### –ß—Ç–æ —É–ª—É—á—à–∏–ª–æ—Å—å:
- üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: +CSRF –Ω–∞ 3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö routes
- üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- üßπ –ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞: –£–±—Ä–∞–Ω console.log –∏–∑ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å CSRF –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º routes + Rate Limiting
