#!/bin/bash

# ================================================
# –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê POSTGRESQL –î–õ–Ø KAMHUB
# ================================================
# –ê–≤—Ç–æ—Ä: Cursor AI Agent
# –î–∞—Ç–∞: 2025-10-30

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                               ‚ïë"
echo "‚ïë         üîß –ù–ê–°–¢–†–û–ô–ö–ê POSTGRESQL –î–õ–Ø KAMHUB                   ‚ïë"
echo "‚ïë                                                               ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ================================================
# 1. –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø
# ================================================

echo -e "${BLUE}‚ñ∂${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ DATABASE_URL..."

if [ -z "$DATABASE_URL" ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!${NC}"
  echo ""
  echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
  echo "  export DATABASE_URL='postgresql://user:password@host:5432/database'"
  echo ""
  echo "–ò–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç:"
  echo "  ./setup-postgresql.sh 'postgresql://user:password@host:5432/database'"
  echo ""
  exit 1
fi

# –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
if [ ! -z "$1" ]; then
  DATABASE_URL="$1"
fi

echo -e "${GREEN}‚úì${NC} DATABASE_URL –Ω–∞–π–¥–µ–Ω–∞"
echo ""

# ================================================
# 2. –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
# ================================================

echo -e "${BLUE}‚ñ∂${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL..."

if ! psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1; then
  echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL!${NC}"
  echo ""
  echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
  echo "  ‚Ä¢ DATABASE_URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
  echo "  ‚Ä¢ PostgreSQL –∑–∞–ø—É—â–µ–Ω"
  echo "  ‚Ä¢ Firewall —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
  echo ""
  exit 1
fi

echo -e "${GREEN}‚úì${NC} –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ"
echo ""

# ================================================
# 3. –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ô
# ================================================

echo -e "${BLUE}‚ñ∂${NC} –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL –º–∏–≥—Ä–∞—Ü–∏–π..."

psql "$DATABASE_URL" -f scripts/init-postgresql.sql

if [ $? -eq 0 ]; then
  echo -e "${GREEN}‚úì${NC} –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π${NC}"
  exit 1
fi

echo ""

# ================================================
# 4. –ü–†–û–í–ï–†–ö–ê –¢–ê–ë–õ–ò–¶
# ================================================

echo -e "${BLUE}‚ñ∂${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü..."

TABLE_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")

echo -e "${GREEN}‚úì${NC} –°–æ–∑–¥–∞–Ω–æ —Ç–∞–±–ª–∏—Ü: $TABLE_COUNT"
echo ""

# ================================================
# 5. –°–û–ó–î–ê–ù–ò–ï –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–• (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
# ================================================

read -p "–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${BLUE}‚ñ∂${NC} –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
  
  psql "$DATABASE_URL" << 'EOF'
-- –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
INSERT INTO users (email, password_hash, name, phone, role)
VALUES (
  'test@kamhub.ru',
  '$2b$10$abcdefghijklmnopqrstuvwxyz',  -- –•–µ—à –ø–∞—Ä–æ–ª—è "test123"
  '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
  '+79001234567',
  'user'
) ON CONFLICT (email) DO NOTHING;

-- –¢–µ—Å—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
INSERT INTO transfer_operators (company_name, license_number, rating, status)
VALUES (
  '–ö–∞–º—á–∞—Ç–∫–∞ –¢—Ä–∞–Ω—Å—Ñ–µ—Ä',
  'LIC-2025-001',
  4.8,
  'active'
) ON CONFLICT DO NOTHING;

\echo '‚úì –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã'
EOF

  echo -e "${GREEN}‚úì${NC} –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"
  echo ""
fi

# ================================================
# 6. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê
# ================================================

echo -e "${BLUE}‚ñ∂${NC} –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

psql "$DATABASE_URL" << 'EOF'
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
SELECT '–†–∞—Å—à–∏—Ä–µ–Ω–∏—è: ' || STRING_AGG(extname, ', ') 
FROM pg_extension 
WHERE extname IN ('uuid-ossp', 'postgis');

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
SELECT '–¢–∞–±–ª–∏—Ü: ' || COUNT(*)::text 
FROM information_schema.tables 
WHERE table_schema = 'public';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT '–ò–Ω–¥–µ–∫—Å–æ–≤: ' || COUNT(*)::text 
FROM pg_indexes 
WHERE schemaname = 'public';
EOF

echo ""

# ================================================
# –ò–¢–û–ì–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# ================================================

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                               ‚ïë"
echo "‚ïë         ‚úÖ POSTGRESQL –ù–ê–°–¢–†–û–ï–ù –£–°–ü–ï–®–ù–û!                      ‚ïë"
echo "‚ïë                                                               ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo -e "${GREEN}‚úì${NC} –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo -e "${GREEN}‚úì${NC} –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã ($TABLE_COUNT —à—Ç)"
echo -e "${GREEN}‚úì${NC} –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã"
echo -e "${GREEN}‚úì${NC} –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo ""
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:"
echo "   ${BLUE}psql \"\$DATABASE_URL\" -c \"\\dt\"${NC}"
echo ""
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ API:"
echo "   ${BLUE}curl https://your-app.timeweb.cloud/api/health/db${NC}"
echo ""
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:"
echo "   ${BLUE}npm start${NC}"
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo -e "${YELLOW}üí° –°–û–í–ï–¢:${NC} –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ CONNECTION STRING –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!"
echo ""
